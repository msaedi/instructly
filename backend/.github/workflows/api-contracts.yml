name: API Contract Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/app/routes/**'
      - 'backend/app/schemas/**'
      - 'backend/tests/test_api_contracts*.py'
      - '.github/workflows/api-contracts.yml'

jobs:
  contract-check:
    runs-on: ubuntu-latest
    name: Check API Contracts

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-contracts-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-contracts-
          ${{ runner.os }}-pip-

    - name: Install minimal dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        # Install only what's needed for contract tests
        pip install pytest pydantic fastapi

    - name: Run contract validation
      working-directory: backend
      run: |
        echo "üîç Checking API contracts..."
        echo "================================"

        # Run the simple contract test that checks for violations
        pytest -v tests/test_api_contracts_simple.py --tb=short

        echo "================================"
        echo "‚úÖ API contracts validated!"

    - name: Comment PR on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `‚ùå **API Contract Violation Detected**

            Your changes introduce API contract violations. Please ensure:
            - All endpoints declare a \`response_model\`
            - No endpoints return raw dictionaries
            - Use proper Pydantic response models

            Run \`pytest tests/test_api_contracts_simple.py\` locally to see violations.`
          })
