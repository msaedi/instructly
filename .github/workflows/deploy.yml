# .github/workflows/deploy.yml
name: Deploy to Vercel
on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'package.json'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
  workflow_dispatch:

concurrency:
  group: vercel-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps & build (frontend)
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Verify Next build artifacts
        working-directory: frontend
        run: |
          test -f .next/routes-manifest.json || { echo "::error::Missing .next/routes-manifest.json. Build likely failed."; exit 1; }

      - name: Pull Vercel project/env (production)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PRODUCTION_PROJECT_ID }}
        run: |
          npx vercel --version
          npx vercel whoami --token "$VERCEL_TOKEN"
          npx vercel pull --yes --environment=production --token "$VERCEL_TOKEN"

      - name: Debug Vercel link (production)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          pwd
          ls -la
          test -f .vercel/project.json && echo "=== .vercel/project.json ===" && cat .vercel/project.json || echo "No .vercel/project.json"
          echo "VERCEL_PROJECT_ID=${{ secrets.VERCEL_PRODUCTION_PROJECT_ID }}"
          echo "VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }}"

      - name: Deploy to Vercel (production)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -eo pipefail
          LOG=../vercel.log
          rm -f "$LOG"
          npx vercel deploy --prod --yes --token "$VERCEL_TOKEN" 2>&1 | tee "$LOG"

      - name: Soft warn on Vercel rate-limit
        if: always()
        run: |
          set +e
          LOG="${{ github.workspace }}/vercel.log"
          if [ -f "$LOG" ]; then
            CONTENT="$(cat "$LOG")"
          else
            CONTENT=""
          fi
          echo "$CONTENT" | grep -qiE 'rate limit|build-rate-limit|Too Many Requests' && {
            echo "::warning::Vercel preview likely hit a rate limit. This check is informational; guardrails remain green.";
          }
          set -e

  deploy-preview:
    name: Deploy to Preview
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps & build (frontend)
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Verify Next build artifacts
        working-directory: frontend
        run: |
          test -f .next/routes-manifest.json || { echo "::error::Missing .next/routes-manifest.json. Build likely failed."; exit 1; }

      - name: Pull Vercel project/env (preview)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PREVIEW_PROJECT_ID }}
        run: |
          npx vercel --version
          npx vercel whoami --token "$VERCEL_TOKEN"
          npx vercel pull --yes --environment=preview --token "$VERCEL_TOKEN"

      - name: Debug Vercel link (preview)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          pwd
          ls -la
          test -f .vercel/project.json && echo "=== .vercel/project.json ===" && cat .vercel/project.json || echo "No .vercel/project.json"
          echo "VERCEL_PROJECT_ID=${{ secrets.VERCEL_PREVIEW_PROJECT_ID }}"
          echo "VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }}"

      - name: Deploy to Vercel (preview)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -eo pipefail
          LOG=../vercel.log
          rm -f "$LOG"
          npx vercel deploy --yes --token "$VERCEL_TOKEN" 2>&1 | tee "$LOG"

      - name: Soft warn on Vercel rate-limit
        if: always()
        run: |
          set +e
          LOG="${{ github.workspace }}/vercel.log"
          if [ -f "$LOG" ]; then
            CONTENT="$(cat "$LOG")"
          else
            CONTENT=""
          fi
          echo "$CONTENT" | grep -qiE 'rate limit|build-rate-limit|Too Many Requests' && {
            echo "::warning::Vercel preview likely hit a rate limit. This check is informational; guardrails remain green.";
          }
          set -e
