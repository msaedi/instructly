# .github/workflows/deploy.yml
name: Deploy to Vercel
on:
  pull_request:
    paths:
      - 'frontend/**'
      - 'package.json'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'package.json'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'

concurrency:
  group: vercel-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Production
        run: |
          set -eo pipefail
          cd frontend
          # Remove any existing .vercel directory to avoid conflicts
          rm -rf .vercel
          # Create .vercel directory
          mkdir -p .vercel
          # Link to the production project
          echo '{"projectId":"${{ secrets.VERCEL_PRODUCTION_PROJECT_ID }}","orgId":"${{ secrets.VERCEL_ORG_ID }}"}' > .vercel/project.json
          # Deploy
          LOG=../vercel.log
          rm -f "$LOG"
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes 2>&1 | tee "$LOG"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PRODUCTION_PROJECT_ID }}

      - name: Soft warn on Vercel rate-limit
        if: always()
        run: |
          set +e
          LOG="${{ github.workspace }}/vercel.log"
          if [ -f "$LOG" ]; then
            CONTENT="$(cat "$LOG")"
          else
            CONTENT=""
          fi
          echo "$CONTENT" | grep -qiE 'rate limit|build-rate-limit|Too Many Requests' && {
            echo "::warning::Vercel preview likely hit a rate limit. This check is informational; guardrails remain green.";
          }
          set -e

  deploy-preview:
    name: Deploy to Preview
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Preview
        run: |
          set -eo pipefail
          cd frontend
          # Remove any existing .vercel directory to avoid conflicts
          rm -rf .vercel
          # Create .vercel directory
          mkdir -p .vercel
          # Link to the preview project
          echo '{"projectId":"${{ secrets.VERCEL_PREVIEW_PROJECT_ID }}","orgId":"${{ secrets.VERCEL_ORG_ID }}"}' > .vercel/project.json
          # Deploy
          LOG=../vercel.log
          rm -f "$LOG"
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes 2>&1 | tee "$LOG"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PREVIEW_PROJECT_ID }}

      - name: Soft warn on Vercel rate-limit
        if: always()
        run: |
          set +e
          LOG="${{ github.workspace }}/vercel.log"
          if [ -f "$LOG" ]; then
            CONTENT="$(cat "$LOG")"
          else
            CONTENT=""
          fi
          echo "$CONTENT" | grep -qiE 'rate limit|build-rate-limit|Too Many Requests' && {
            echo "::warning::Vercel preview likely hit a rate limit. This check is informational; guardrails remain green.";
          }
          set -e
