name: schemathesis (read-only)

on:
  schedule:
    - cron: '0 8 * * *' # daily 8:00 UTC (adjust if you use a different time)
  workflow_dispatch:
    inputs:
      target:
        description: "Which environment to test"
        required: false
        default: "all"
        type: choice
        options: [preview, beta, all]

jobs:
  preview:
    if: github.event_name == 'schedule' || github.event.inputs.target == 'all' || github.event.inputs.target == 'preview'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Schemathesis (pinned)
        run: |
          python -m pip install --upgrade pip
          pip install schemathesis==4.1.4

      - name: Run Schemathesis (preview, GET/HEAD only)
        env:
          BASE_URL: ${{ vars.PREVIEW_API_BASE_URL }}
        run: |
          mkdir -p .artifacts
          set -eo pipefail
          echo "Target: ${BASE_URL}"
          # capture stdout/stderr
          schemathesis run "${BASE_URL}/openapi.json" \
            --include-method GET --include-method HEAD \
            --phases=examples \
            --checks not_a_server_error \
            --workers=4 \
            2>&1 | tee .artifacts/schemathesis-preview.log

      - name: Summarize & publish evidence (preview)
        if: always()
        run: |
          set -eo pipefail
          EVIDENCE=".artifacts/schemathesis-preview-evidence.txt"
          LOG=".artifacts/schemathesis-preview.log"
          if [ -f "$LOG" ]; then
            TOTAL=$(grep -Eo 'Total\stest\scases:\s+[0-9]+' "$LOG" | awk '{print $4}' | tail -1 || echo 0)
            ERR=$(grep -Eo 'Errors:\s+[0-9]+' "$LOG" | awk '{print $2}' | tail -1 || echo 0)
            FAIL=$(grep -Eo 'Failures:\s+[0-9]+' "$LOG" | awk '{print $2}' | tail -1 || echo 0)
            PASS=$(grep -Eo 'Passed:\s+[0-9]+' "$LOG" | awk '{print $2}' | tail -1 || echo 0)
            {
              echo "[schemathesis-preview] total=${TOTAL} passed=${PASS} failures=${FAIL} errors=${ERR}"
            } | tee "$EVIDENCE"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            cat "$EVIDENCE" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::warning::No schemathesis log found for preview"
          fi

      - name: Upload artifacts (preview)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schemathesis-evidence-preview
          path: |
            .artifacts/schemathesis-preview.log
            .artifacts/schemathesis-preview-evidence.txt
          retention-days: 30

  beta:
    if: github.event_name == 'schedule' || github.event.inputs.target == 'all' || github.event.inputs.target == 'beta'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Schemathesis (pinned)
        run: |
          python -m pip install --upgrade pip
          pip install schemathesis==4.1.4

      - name: Run Schemathesis (beta, GET/HEAD only)
        env:
          BASE_URL: ${{ vars.BETA_API_BASE_URL }}
        run: |
          mkdir -p .artifacts
          set -eo pipefail
          echo "Target: ${BASE_URL}"
          schemathesis run "${BASE_URL}/openapi.json" \
            --include-method GET --include-method HEAD \
            --phases=examples \
            --checks not_a_server_error \
            --workers=4 \
            2>&1 | tee .artifacts/schemathesis-beta.log

      - name: Summarize & publish evidence (beta)
        if: always()
        run: |
          set -eo pipefail
          EVIDENCE=".artifacts/schemathesis-beta-evidence.txt"
          LOG=".artifacts/schemathesis-beta.log"
          if [ -f "$LOG" ]; then
            TOTAL=$(grep -Eo 'Total\stest\scases:\s+[0-9]+' "$LOG" | awk '{print $4}' | tail -1 || echo 0)
            ERR=$(grep -Eo 'Errors:\s+[0-9]+' "$LOG" | awk '{print $2}' | tail -1 || echo 0)
            FAIL=$(grep -Eo 'Failures:\s+[0-9]+' "$LOG" | awk '{print $2}' | tail -1 || echo 0)
            PASS=$(grep -Eo 'Passed:\s+[0-9]+' "$LOG" | awk '{print $2}' | tail -1 || echo 0)
            {
              echo "[schemathesis-beta] total=${TOTAL} passed=${PASS} failures=${FAIL} errors=${ERR}"
            } | tee "$EVIDENCE"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            cat "$EVIDENCE" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::warning::No schemathesis log found for beta"
          fi

      - name: Upload artifacts (beta)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schemathesis-evidence-beta
          path: |
            .artifacts/schemathesis-beta.log
            .artifacts/schemathesis-beta-evidence.txt
          retention-days: 30
