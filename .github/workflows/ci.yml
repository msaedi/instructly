name: CI

on:
  push:
    branches: [ main ]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  contract-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python for OpenAPI export
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements-openapi.txt

      - name: Install Python deps for OpenAPI export
        working-directory: backend
        run: pip install -r requirements-openapi.txt

      # Node for contract check
      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Show Node versions (debug)
        run: node -v && npm -v

      - name: Contract check
        working-directory: frontend
        run: node scripts/contract-check.mjs

  lint-build:
    needs: contract-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Show Node versions (debug)
        run: node -v && npm -v
      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint
        working-directory: frontend
        run: npm run lint:ci

      - name: Verify public env usage
        working-directory: frontend
        run: npm run verify:public-env

      - name: Typecheck
        working-directory: frontend
        run: npm run typecheck:strict

      - name: Contract audit (guardrail)
        working-directory: frontend
        run: npm run audit:contract:ci

      - name: Read audit metrics
        id: audit
        working-directory: frontend
        run: |
          jq -r '. as $j | "drift=\($j.drift)\noutside=\($j.directImports.outsideAllowed)\nvia=\($j.viaShimCount)"' .artifacts/contract-audit.json >> $GITHUB_OUTPUT

      - name: Read adoption metrics
        id: adopt
        working-directory: frontend
        run: |
          jq -r '. as $j | "adHocAny=\($j.adHocAnyCallSites)"' .artifacts/contract-adoption.json >> $GITHUB_OUTPUT

      - name: Summarize audit
        working-directory: frontend
        run: |
          echo "### FE⇄BE contract audit" >> $GITHUB_STEP_SUMMARY
          echo "- Drift: ${{ steps.audit.outputs.drift }}" >> $GITHUB_STEP_SUMMARY
          echo "- Direct imports (outside allowed): ${{ steps.audit.outputs.outside }}" >> $GITHUB_STEP_SUMMARY
          echo "- Imports via shim: ${{ steps.audit.outputs.via }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ad-hoc/any call-sites: ${{ steps.adopt.outputs.adHocAny }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See attached artifact for full report and adoption targets." >> $GITHUB_STEP_SUMMARY

      - name: Fail on drift or forbidden direct imports
        if: steps.audit.outputs.drift == 'true' || steps.audit.outputs.outside != '0'
        run: |
          echo "❌ Contract guardrail failed: drift or forbidden direct imports detected."
          exit 1

      - name: Warn if shim adoption below target
        if: steps.audit.outputs.via < 20
        run: echo "⚠️ Shim adoption below target (20); consider wiring more call sites."

      - name: Warn if ad-hoc/any call-sites detected
        if: steps.adopt.outputs.adHocAny != '0'
        run: echo "⚠️ Found ${{ steps.adopt.outputs.adHocAny }} ad-hoc/any API call-sites (see adoption artifacts)."

      - name: Upload contract audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contract-audit
          path: |
            frontend/.artifacts/contract-audit.json
            frontend/.artifacts/contract-audit-report.md
            frontend/.artifacts/contract-adoption.json
            frontend/.artifacts/contract-adoption.md

      - name: Build
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_BASE: https://example.invalid
        run: npm run build:log

      - name: Ensure runtime validation not in prod bundle
        working-directory: frontend
        run: npm run verify:runtime-validation-bundle

      - name: Size limit
        working-directory: frontend
        run: npm run size

      - name: Size limit (summary)
        working-directory: frontend
        run: |
          npx --yes size-limit --json > .artifacts/size-limit.json || true
          echo "size-limit: completed (see .artifacts/size-limit.json)" >> $GITHUB_STEP_SUMMARY

      - name: Type smoke tests
        working-directory: frontend
        run: npm run type:smoke:ci

      - name: Type smoke (summary)
        working-directory: frontend
        run: |
          echo "type-smoke: completed" >> $GITHUB_STEP_SUMMARY

      - name: Dead code audit (warn)
        working-directory: frontend
        run: npm run audit:deadcode:ci

      - name: Dead code (summary)
        working-directory: frontend
        run: |
          echo "deadcode: audit completed (warn-mode)" >> $GITHUB_STEP_SUMMARY

      - name: Lighthouse CI (warn)
        working-directory: frontend
        run: npm run audit:lhci || echo "::warning ::LHCI reported issues"

      - name: Lighthouse (summary)
        working-directory: frontend
        run: |
          echo "lhci: completed (see .artifacts/lhci)" >> $GITHUB_STEP_SUMMARY

      - name: Type coverage (fail-gate >=99%)
        working-directory: frontend
        run: npm run audit:typecov:ci

      - name: Type coverage (summary)
        working-directory: frontend
        run: |
          npx --yes type-coverage --detail | sed -n 's/^type-coverage: /type-coverage: /p' | head -1 >> $GITHUB_STEP_SUMMARY || true
      - name: Pin check (codegen/tooling)
        run: node scripts/check-pins.mjs
      - name: Dependency cruiser (fail-gate)
        working-directory: frontend
        run: |
          mkdir -p .artifacts
          npx --yes dependency-cruiser --config dependency-cruiser.config.cjs --ts-config tsconfig.json app components features hooks lib --output-type json > .artifacts/depcruise.json
          ERRORS=$(jq '.summary.error // 0' .artifacts/depcruise.json)
          echo "dep-cruiser errors: ${ERRORS}" >> $GITHUB_STEP_SUMMARY
          test "${ERRORS}" -eq 0
      - name: Unused exports (ts-prune) fail-gate
        working-directory: frontend
        run: |
          npm run audit:exports:ci
          COUNT=$(wc -l < .artifacts/ts-prune.txt | tr -d ' \n')
          echo "ts-prune offenders: ${COUNT}" >> $GITHUB_STEP_SUMMARY
          test "${COUNT}" -eq 0
      - name: Gitleaks (fail-gate)
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz gitleaks && sudo mv gitleaks /usr/local/bin/
          bash scripts/run-gitleaks.sh
      - name: Type coverage (weekly summary json)
        working-directory: frontend
        run: |
          mkdir -p .artifacts
          npx --yes type-coverage --detail | sed -n 's/^type-coverage: //p' | head -1 | awk '{print $1}' | sed 's/%//' > .artifacts/typecov.current
          echo "{\"coverage\": $(cat .artifacts/typecov.current)}" > .artifacts/typecov.json
          echo "type-coverage-json: $(cat .artifacts/typecov.json)" >> $GITHUB_STEP_SUMMARY

      - name: Setup Python 3.11 for backend checks
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend lint/type tools
        run: pip install -q "ruff==0.5.7" mypy

      - name: Ruff (backend app)
        working-directory: backend
        run: ruff check app --select F,I

      - name: Setup Python 3.11 for backend mypy
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install mypy and required libs
        run: pip install -q mypy types-pytz "pydantic~=2.8" "pydantic-core~=2.23" fastapi pip-audit

      - name: pip-audit (warn or fail)
        working-directory: backend
        run: |
          pip-audit -r requirements.txt -r requirements-openapi.txt -r requirements-dev.txt --strict || echo "::warning ::pip-audit reported issues"
      - name: npm audit (warn or fail)
        working-directory: frontend
        run: |
          npm audit --omit=dev --audit-level=high --json | node scripts/parse-npm-audit.js || echo "::warning ::npm audit reported high/critical issues"

      - name: MyPy (schemas/internal) fail-gate
        working-directory: backend
        run: mypy app/schemas app/routes/internal.py

      - name: MyPy (summary)
        run: |
          echo "mypy (narrow): completed" >> $GITHUB_STEP_SUMMARY
      - name: MyPy (widened set - warn)
        working-directory: backend
        run: |
          mypy app/repositories/search_history_repository.py app/services/search_history_cleanup_service.py app/routes/search_history.py || true
          echo "mypy (widened warn): completed" >> $GITHUB_STEP_SUMMARY

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Show Node versions (debug)
        run: node -v && npm -v
      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Unit tests
        working-directory: frontend
        run: npm run test --silent

  env-contract-smoke:
    if: ${{ vars.PLAYWRIGHT_BASE_URL != '' }}
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_BASE_URL: ${{ vars.PLAYWRIGHT_BASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      - name: Install Playwright browsers
        working-directory: frontend
        run: npx --yes playwright install --with-deps
      - name: Run env-contract smoke
        working-directory: frontend
        run: npx --yes playwright test e2e/env-contract.spec.ts
      - name: Summarize env-contract
        run: |
          echo "env-contract: completed (base=${PLAYWRIGHT_BASE_URL})" >> $GITHUB_STEP_SUMMARY

      # Uncomment if you want e2e in CI here
      # - name: Install Playwright browsers
      #   working-directory: frontend
      #   run: npm run playwright:install
      #
      # - name: E2E tests
      #   working-directory: frontend
      #   run: npm run test:e2e:ci
