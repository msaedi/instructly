name: CI

on:
  push:
    branches: [ main ]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  contract-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python for OpenAPI export
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements-openapi.txt

      - name: Install Python deps for OpenAPI export
        working-directory: backend
        run: pip install -r requirements-openapi.txt

      # Node for contract check
      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Show Node versions (debug)
        run: node -v && npm -v

      - name: Contract check
        working-directory: frontend
        run: node scripts/contract-check.mjs

  lint-build:
    needs: contract-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Show Node versions (debug)
        run: node -v && npm -v
      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint
        working-directory: frontend
        run: npm run lint:ci

      - name: Verify public env usage
        working-directory: frontend
        run: npm run verify:public-env

      - name: Typecheck
        working-directory: frontend
        run: npm run typecheck:strict

      - name: Contract audit (guardrail)
        working-directory: frontend
        run: npm run audit:contract:ci

      - name: Read audit metrics
        id: audit
        working-directory: frontend
        run: |
          jq -r '. as $j | "drift=\($j.drift)\noutside=\($j.directImports.outsideAllowed)\nvia=\($j.viaShimCount)"' .artifacts/contract-audit.json >> $GITHUB_OUTPUT

      - name: Read adoption metrics
        id: adopt
        working-directory: frontend
        run: |
          jq -r '. as $j | "adHocAny=\($j.adHocAnyCallSites)"' .artifacts/contract-adoption.json >> $GITHUB_OUTPUT

      - name: Summarize audit
        working-directory: frontend
        run: |
          echo "### FE⇄BE contract audit" >> $GITHUB_STEP_SUMMARY
          echo "- Drift: ${{ steps.audit.outputs.drift }}" >> $GITHUB_STEP_SUMMARY
          echo "- Direct imports (outside allowed): ${{ steps.audit.outputs.outside }}" >> $GITHUB_STEP_SUMMARY
          echo "- Imports via shim: ${{ steps.audit.outputs.via }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ad-hoc/any call-sites: ${{ steps.adopt.outputs.adHocAny }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See attached artifact for full report and adoption targets." >> $GITHUB_STEP_SUMMARY

      - name: Fail on drift or forbidden direct imports
        if: steps.audit.outputs.drift == 'true' || steps.audit.outputs.outside != '0'
        run: |
          echo "❌ Contract guardrail failed: drift or forbidden direct imports detected."
          exit 1

      - name: Warn if shim adoption below target
        if: steps.audit.outputs.via < 20
        run: echo "⚠️ Shim adoption below target (20); consider wiring more call sites."

      - name: Warn if ad-hoc/any call-sites detected
        if: steps.adopt.outputs.adHocAny != '0'
        run: echo "⚠️ Found ${{ steps.adopt.outputs.adHocAny }} ad-hoc/any API call-sites (see adoption artifacts)."

      - name: Upload contract audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contract-audit
          path: |
            frontend/.artifacts/contract-audit.json
            frontend/.artifacts/contract-audit-report.md
            frontend/.artifacts/contract-adoption.json
            frontend/.artifacts/contract-adoption.md

      - name: Build
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_BASE: https://example.invalid
        run: npm run build:log

      - name: Ensure runtime validation not in prod bundle
        working-directory: frontend
        run: npm run verify:runtime-validation-bundle

      - name: Size limit (warn)
        working-directory: frontend
        run: npm run size || echo "::warning ::size-limit reported issues"

      - name: Type smoke tests (warn)
        working-directory: frontend
        run: npm run type:smoke || echo "::warning ::tsd smoke reported issues"

      - name: Dead code audit (warn)
        working-directory: frontend
        run: npm run audit:deadcode:ci

      - name: Lighthouse CI (warn)
        working-directory: frontend
        run: npm run audit:lhci || echo "::warning ::LHCI reported issues"

      - name: Type coverage (warn)
        working-directory: frontend
        run: npm run audit:typecov || echo "::warning ::type-coverage reported issues"

      - name: Setup Python 3.11 for backend checks
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend lint/type tools
        run: pip install -q ruff mypy

      - name: Ruff (warn)
        run: python -m ruff check backend || echo "::warning ::ruff reported issues"

      - name: MyPy (scoped, warn)
        run: mypy backend/app/schemas/base.py backend/app/schemas/search_history_responses.py backend/app/routes/internal.py || echo "::warning ::mypy reported issues"

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Show Node versions (debug)
        run: node -v && npm -v
      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Unit tests
        working-directory: frontend
        run: npm run test --silent

      # Uncomment if you want e2e in CI here
      # - name: Install Playwright browsers
      #   working-directory: frontend
      #   run: npm run playwright:install
      #
      # - name: E2E tests
      #   working-directory: frontend
      #   run: npm run test:e2e:ci
