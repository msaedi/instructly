name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      invite_e2e:
        description: 'Run cross-origin invite e2e job'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  contract-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python for OpenAPI export (frontend contract audit reads this)
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements-openapi.txt

      - name: Install Python deps for OpenAPI export
        working-directory: backend
        run: pip install -r requirements-openapi.txt

      # Node for contract check
      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Show Node versions (debug)
        run: node -v && npm -v

      - name: Contract check
        working-directory: frontend
        run: node scripts/contract-check.mjs

  lint-build:
    needs: contract-check
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      STG_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      PROD_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
    services:
      postgres:
        image: ghcr.io/msaedi/instructly-ci-postgres:14-postgis-pgvector
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: instainstru_test
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Show Node versions (debug)
        run: node -v && npm -v

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint
        working-directory: frontend
        run: npm run lint:ci

      - name: Verify public env usage
        working-directory: frontend
        run: npm run verify:public-env

      - name: Typecheck
        working-directory: frontend
        run: npm run typecheck:strict

      - name: Contract audit (guardrail)
        working-directory: frontend
        run: npm run audit:contract:ci

      - name: Read audit metrics
        id: audit
        working-directory: frontend
        run: |
          jq -r '. as $j | "drift=\($j.drift)\noutside=\($j.directImports.outsideAllowed)\nvia=\($j.viaShimCount)"' .artifacts/contract-audit.json >> $GITHUB_OUTPUT

      - name: Read adoption metrics
        id: adopt
        working-directory: frontend
        run: |
          jq -r '. as $j | "adHocAny=\($j.adHocAnyCallSites)"' .artifacts/contract-adoption.json >> $GITHUB_OUTPUT

      - name: Summarize contract audit
        working-directory: frontend
        run: |
          echo "### FE⇄BE contract audit" >> $GITHUB_STEP_SUMMARY
          echo "- Drift: ${{ steps.audit.outputs.drift }}" >> $GITHUB_STEP_SUMMARY
          echo "- Direct imports (outside allowed): ${{ steps.audit.outputs.outside }}" >> $GITHUB_STEP_SUMMARY
          echo "- Imports via shim: ${{ steps.audit.outputs.via }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ad-hoc/any call-sites: ${{ steps.adopt.outputs.adHocAny }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See attached artifact for full report and adoption targets." >> $GITHUB_STEP_SUMMARY

      - name: Fail on drift or forbidden direct imports
        if: steps.audit.outputs.drift == 'true' || steps.audit.outputs.outside != '0'
        run: |
          echo "❌ Contract guardrail failed: drift or forbidden direct imports detected."
          exit 1

      - name: Warn if shim adoption below target
        if: steps.audit.outputs.via < 20
        run: echo "⚠️ Shim adoption below target (20); consider wiring more call sites."

      - name: Warn if ad-hoc/any call-sites detected
        if: steps.adopt.outputs.adHocAny != '0'
        run: echo "⚠️ Found ${{ steps.adopt.outputs.adHocAny }} ad-hoc/any API call-sites (see adoption artifacts)."

      - name: Upload contract audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contract-audit
          path: |
            frontend/.artifacts/contract-audit.json
            frontend/.artifacts/contract-audit-report.md
            frontend/.artifacts/contract-adoption.json
            frontend/.artifacts/contract-adoption.md

      - name: Guardrail #12 – enforce exact pins for codegen/test deps
        shell: bash
        working-directory: frontend
        run: |
          set -euo pipefail
          must_pin=(
            "openapi-typescript"
            "@playwright/test"
            "@axe-core/playwright"
          )
          for pkg in "${must_pin[@]}"; do
            ver="$(jq -r --arg k "$pkg" '.dependencies[$k] // .devDependencies[$k] // ""' package.json)"
            if [ -z "${ver}" ]; then
              echo "warn: ${pkg} not found; skipping"
              continue
            fi
            if [[ ! "${ver}" =~ ^[0-9]+(\.[0-9]+)*(-[0-9A-Za-z.]+)?$ ]]; then
              echo "error: ${pkg} must be exactly pinned, found \"${ver}\""
              exit 1
            fi
            echo "ok: ${pkg} pinned to ${ver}"
          done

      - name: Build
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_BASE: https://example.invalid
        run: npm run build:log

      - name: Ensure runtime validation not in prod bundle
        working-directory: frontend
        run: npm run verify:runtime-validation-bundle

      - name: Size limit
        working-directory: frontend
        run: npm run size

      - name: Size limit (summary)
        working-directory: frontend
        run: |
          npx --yes size-limit --json > .artifacts/size-limit.json || true
          echo "size-limit: completed (see .artifacts/size-limit.json)" >> $GITHUB_STEP_SUMMARY

      - name: Type smoke tests
        working-directory: frontend
        run: npm run type:smoke:ci

      - name: Type smoke (summary)
        working-directory: frontend
        run: |
          echo "type-smoke: completed" >> $GITHUB_STEP_SUMMARY

      # DEAD CODE → BASELINE-GATED FAIL
      - name: Dead code audit (collect JSON)
        working-directory: frontend
        run: |
          mkdir -p .artifacts
          npx --yes knip --config knip.config.mjs --reporter json > .artifacts/knip.json || true
          if [ ! -s .artifacts/knip.json ]; then echo '{"issues":[]}' > .artifacts/knip.json; fi
          jq '.issues | length // 0' .artifacts/knip.json > .artifacts/knip.count

      - name: Dead code (baseline-gated fail)
        working-directory: frontend
        run: |
          BASELINE_FILE=.artifacts/baselines/knip.count
          CURRENT=$(cat .artifacts/knip.count)
          if [[ ! -f "$BASELINE_FILE" ]]; then
            mkdir -p .artifacts/baselines
            echo "$CURRENT" > "$BASELINE_FILE"
            echo "deadcode: baseline created with ${CURRENT}" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          # Initialize baseline if empty or invalid
          if [[ ! -s "$BASELINE_FILE" ]] || ! grep -Eq '^[0-9]+$' "$BASELINE_FILE"; then
            echo "$CURRENT" > "$BASELINE_FILE"
            echo "deadcode: baseline initialized to ${CURRENT}" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          BASELINE=$(cat "$BASELINE_FILE")
          echo "deadcode: baseline=${BASELINE}, current=${CURRENT}" >> $GITHUB_STEP_SUMMARY
          if (( CURRENT > BASELINE )); then
            echo "❌ Dead code increased (current ${CURRENT} > baseline ${BASELINE})"
            exit 1
          fi

      - name: Dead code (summary)
        working-directory: frontend
        run: |
          echo "deadcode: OK (no increase from baseline)" >> $GITHUB_STEP_SUMMARY

      # LIGHTHOUSE → BASELINE-GATED FAIL
      - name: Lighthouse CI (collect JSON)
        working-directory: frontend
        run: |
          mkdir -p .artifacts
          npx --yes @lhci/cli collect --config=./lighthouserc.json --output=json --output-path=.artifacts/lhci-lhr.json || true
          if [[ -f .artifacts/lhci-lhr.json ]]; then
            jq '.categories.performance.score // 0' .artifacts/lhci-lhr.json > .artifacts/lhci.performance
          else
            echo "0" > .artifacts/lhci.performance
          fi

      - name: Lighthouse (baseline-gated fail)
        working-directory: frontend
        run: |
          BASELINE_FILE=.artifacts/baselines/lhci.performance
          CURRENT=$(cat .artifacts/lhci.performance)
          if [[ ! -f "$BASELINE_FILE" ]]; then
            mkdir -p .artifacts/baselines
            echo "$CURRENT" > "$BASELINE_FILE"
            echo "lhci: baseline created with ${CURRENT}" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          BASELINE=$(cat "$BASELINE_FILE")
          echo "lhci: baseline=${BASELINE}, current=${CURRENT}" >> $GITHUB_STEP_SUMMARY
          awk -v c="$CURRENT" -v b="$BASELINE" 'BEGIN { if (c+0 < b+0) exit 1; }' || { echo "❌ Lighthouse performance regressed"; exit 1; }

      - name: Lighthouse (summary)
        working-directory: frontend
        run: |
          echo "lhci: OK (no regression vs baseline)" >> $GITHUB_STEP_SUMMARY

      - name: Type coverage (fail-gate ≥99%)
        working-directory: frontend
        run: npm run audit:typecov:ci

      - name: Type coverage (summary)
        working-directory: frontend
        run: |
          npx --yes type-coverage --detail | sed -n 's/^type-coverage: /type-coverage: /p' | head -1 >> $GITHUB_STEP_SUMMARY || true

      - name: Pin check (codegen/tooling)
        run: node scripts/check-pins.mjs

      - name: Dependency cruiser (fail-gate)
        working-directory: frontend
        run: |
          mkdir -p .artifacts
          npx --yes dependency-cruiser --config dependency-cruiser.config.cjs --ts-config tsconfig.json app components features hooks lib --output-type json > .artifacts/depcruise.json
          ERRORS=$(jq '.summary.error // 0' .artifacts/depcruise.json)
          echo "dep-cruiser errors: ${ERRORS}" >> $GITHUB_STEP_SUMMARY
          test "${ERRORS}" -eq 0

      - name: Unused exports (ts-prune) fail-gate
        working-directory: frontend
        run: |
          npm run audit:exports:ci
          COUNT=$(wc -l < .artifacts/ts-prune.txt | tr -d ' \n')
          echo "ts-prune offenders: ${COUNT}" >> $GITHUB_STEP_SUMMARY
          test "${COUNT}" -eq 0

      - name: Gitleaks (fail-gate)
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz gitleaks && sudo mv gitleaks /usr/local/bin/
          bash scripts/run-gitleaks.sh

      - name: Type coverage (weekly summary json)
        working-directory: frontend
        run: |
          mkdir -p .artifacts
          npx --yes type-coverage --detail | sed -n 's/^type-coverage: //p' | head -1 | awk '{print $1}' | sed 's/%//' > .artifacts/typecov.current
          echo "{\"coverage\": $(cat .artifacts/typecov.current)}" > .artifacts/typecov.json
          echo "type-coverage-json: $(cat .artifacts/typecov.json)" >> $GITHUB_STEP_SUMMARY

      # Backend setup
      - name: Setup Python 3.11 for backend checks
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Wait for Postgres
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
        run: |
          for i in {1..60}; do
            (echo > /dev/tcp/127.0.0.1/5432) >/dev/null 2>&1 && echo "Postgres is up" && break
            echo "Waiting for Postgres..."; sleep 2;
          done

      - name: Install backend lint/type tools
        run: pip install -q "ruff==0.5.7" mypy types-pytz "pydantic~=2.8" "pydantic-core~=2.23" fastapi pip-audit pytest resend==2.4.0

      - name: Ruff (backend app)
        working-directory: backend
        run: ruff check app --select F,I

      - name: pip-audit (fail-on-new)
        working-directory: backend
        run: bash scripts/run_pip_audit.sh

      - name: npm audit (fail-on-new)
        working-directory: frontend
        run: |
          npm audit --omit=dev --audit-level=high --json | node scripts/parse-npm-audit.js

      - name: MyPy (schemas/internal + payments) fail-gate
        working-directory: backend
        run: mypy app/schemas app/routes/internal.py app/repositories/search_history_repository.py app/services/search_history_cleanup_service.py app/routes/search_history.py app/services/stripe_service.py

      - name: MyPy (narrow) count → summary
        working-directory: backend
        run: |
          mkdir -p .artifacts
          mypy app/schemas app/routes/internal.py app/repositories/search_history_repository.py app/services/search_history_cleanup_service.py app/routes/search_history.py app/services/stripe_service.py > .artifacts/mypy_narrow.txt || true
          COUNT=$(grep -Eo 'Found [0-9]+ errors' .artifacts/mypy_narrow.txt | awk '{print $2}')
          COUNT=${COUNT:-0}
          echo "mypy(narrow): ${COUNT} errors" >> $GITHUB_STEP_SUMMARY
          mypy app/schemas app/routes/internal.py app/repositories/search_history_repository.py app/services/search_history_cleanup_service.py app/routes/search_history.py app/services/stripe_service.py

      - name: "MyPy (fail-mode: bookings/availability slice)"
        working-directory: backend
        run: |
          mypy \
            app/repositories/booking_repository.py \
            app/repositories/availability_repository.py \
            app/repositories/week_operation_repository.py \
            app/services/booking_service.py \
            app/services/conflict_checker.py \
            app/services/week_operation_service.py \
            app/routes/bookings.py \
            app/routes/availability_windows.py
          echo "mypy fail (bookings/availability): completed" >> $GITHUB_STEP_SUMMARY

      - name: MyPy (slice) count → summary
        working-directory: backend
        run: |
          mkdir -p .artifacts
          mypy \
            app/repositories/booking_repository.py \
            app/repositories/availability_repository.py \
            app/repositories/week_operation_repository.py \
            app/services/booking_service.py \
            app/services/conflict_checker.py \
            app/services/week_operation_service.py \
            app/routes/bookings.py \
            app/routes/availability_windows.py > .artifacts/mypy_slice.txt || true
          COUNT=$(grep -Eo 'Found [0-9]+ errors' .artifacts/mypy_slice.txt | awk '{print $2}')
          COUNT=${COUNT:-0}
          echo "mypy(bookings/availability): ${COUNT} errors" >> $GITHUB_STEP_SUMMARY

      - name: Mypy strict coverage check
        run: python tools/check_mypy_coverage.py

      - name: Backend request DTO strict scanner
        run: python tools/check_request_dto_strict.py

      - name: Backend routes response_model scanner
        run: python tools/check_routes_response_model.py

      - name: Mypy baseline gate
        run: bash tools/mypy_strict_gate.sh

      - name: Strict schemas & error envelope tests (flagged)
        working-directory: backend
        env:
          STRICT_SCHEMAS: "true"
          STG_DATABASE_URL: ${{ env.STG_DATABASE_URL }}
          TZ: UTC
        run: |
          python -m pytest -q tests/integration/test_error_envelope.py
          python -m pytest -q tests/integration/search_history/test_strict_schemas.py

      - name: Full guardrails audit (report)
        working-directory: tools
        run: python audit_all.py

      - name: Strictness summary
        run: |
          echo "problem+json envelope: PASS" >> $GITHUB_STEP_SUMMARY
          echo "strict schemas (scope=search_history,internal): PASS" >> $GITHUB_STEP_SUMMARY

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Show Node versions (debug)
        run: node -v && npm -v

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Unit tests
        working-directory: frontend
        run: npm run test --silent

  env-contract-smoke:
    if: ${{ vars.PLAYWRIGHT_BASE_URL != '' }}
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_BASE_URL: ${{ vars.PLAYWRIGHT_BASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      - name: Install Playwright browsers
        working-directory: frontend
        run: npx --yes playwright install --with-deps
      - name: Run env-contract smoke
        working-directory: frontend
        run: npx --yes playwright test e2e/env-contract.spec.ts

      - name: Detect component changes
        id: paths
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.pull_request.base.sha || github.event.before || 'origin/main' }}
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          filters: |
            components:
              - 'frontend/components/**'

      - name: Set a11y strict on component changes
        if: steps.paths.outputs.components == 'true'
        run: |
          echo "A11Y_STRICT=1" >> $GITHUB_ENV
          echo "A11Y_IMPACTS=serious,critical" >> $GITHUB_ENV

      - name: Run a11y smoke (non-blocking unless strict)
        shell: bash
        working-directory: frontend
        env:
          DEFAULT_A11Y_IMPACTS: ${{ vars.A11Y_IMPACTS || secrets.A11Y_IMPACTS || 'critical' }}
          DEFAULT_A11Y_STRICT: ${{ vars.A11Y_STRICT || secrets.A11Y_STRICT || '0' }}
          DEFAULT_E2E_A11Y_STRICT: ${{ vars.E2E_A11Y_STRICT || secrets.E2E_A11Y_STRICT || '' }}
        run: |
          set -eo pipefail
          : "${A11Y_IMPACTS:=${DEFAULT_A11Y_IMPACTS}}"
          : "${A11Y_STRICT:=${DEFAULT_A11Y_STRICT}}"
          : "${E2E_A11Y_STRICT:=${DEFAULT_E2E_A11Y_STRICT}}"
          status=0
          npx --yes playwright test e2e/a11y.smoke.spec.ts --reporter=line || status=$?
          echo "A11Y_EXIT=${status}"
          strict_flag="${A11Y_STRICT:-${E2E_A11Y_STRICT:-0}}"
          if [ "${strict_flag}" = "1" ] && [ "${status}" -ne 0 ]; then
            exit "${status}"
          fi

      - name: Upload a11y artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-report
          path: frontend/.artifacts/a11y-report.tgz
      - name: Summarize env-contract
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}
        run: |
          echo "env-contract: completed (base=${PLAYWRIGHT_BASE_URL})" >> $GITHUB_STEP_SUMMARY

  invite-e2e:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.invite_e2e == 'true' }}
    needs:
      - lint-build
      - frontend-tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: instainstru_test
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
      redis:
        image: redis:7-alpine
        ports:
          - "6379:6379"
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    env:
      PLAYWRIGHT_BASE_URL: http://localhost:3000
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      STG_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      PROD_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
    steps:
      - uses: actions/checkout@v4

      - name: Append beta-local host alias
        run: |
          echo "127.0.0.1 beta-local.instainstru.com" | sudo tee -a /etc/hosts

      - name: Prepare artifacts directory
        run: |
          mkdir -p .artifacts
          touch .artifacts/backend.log .artifacts/frontend.log

      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        working-directory: backend
        run: pip install -r requirements.txt

      - name: Prepare database
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
          TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
          STG_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
        run: |
          export stg_database_url="$STG_DATABASE_URL"
          export prod_database_url="$PROD_DATABASE_URL"
          until pg_isready -h localhost -p 5432 -U postgres; do sleep 1; done
          psql "postgresql://postgres:postgres@localhost:5432/postgres" -c 'CREATE DATABASE instainstru_test;' || true
          psql "$DATABASE_URL" -c "SELECT extname FROM pg_extension;"

      - name: Run migrations and seed data
        working-directory: backend
        env:
          SITE_MODE: local
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
          TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
          STG_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
        run: |
          export stg_database_url="$STG_DATABASE_URL"
          export prod_database_url="$PROD_DATABASE_URL"
          alembic upgrade head
          python scripts/reset_and_seed_yaml.py

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx --yes playwright install --with-deps

      - name: Start backend
        working-directory: backend
        env:
          SITE_MODE: local
          SECRET_KEY: dev-e2e-secret
          ALLOWED_ORIGINS: http://localhost:3000,http://beta-local.instainstru.com:3000
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
          TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
          STG_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
          PROD_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
          redis_url: redis://localhost:6379/0
        run: |
          rm -f ../.artifacts/backend.log
          touch ../.artifacts/backend.log
          export stg_database_url="$STG_DATABASE_URL"
          export prod_database_url="$PROD_DATABASE_URL"
          nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 >> ../.artifacts/backend.log 2>&1 &
          echo $! > ../.artifacts/backend.pid

      - name: Start frontend (preview/beta)
        working-directory: frontend
        env:
          NEXT_PUBLIC_APP_ENV: preview
          NEXT_PUBLIC_API_BASE: http://localhost:8000
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          NODE_ENV: development
        run: |
          rm -f ../.artifacts/frontend.log
          touch ../.artifacts/frontend.log
          nohup npm run dev -- --hostname 0.0.0.0 --port 3000 >> ../.artifacts/frontend.log 2>&1 &
          echo $! > ../.artifacts/frontend.pid

      - name: Wait for services
        run: |
          npx --yes wait-on http://127.0.0.1:8000/health http://localhost:3000
          curl -sSf http://beta-local.instainstru.com:3000 >/dev/null

      - name: Run invite redemption e2e
        working-directory: frontend
        env:
          CI_LOCAL_E2E: '1'
          PLAYWRIGHT_BASE_URL: http://localhost:3000
        run: npx --yes playwright test e2e/invites.invite-redemption.spec.ts --reporter=line --trace on-first-retry

      - name: Stop services
        if: always()
        run: |
          if [ -f .artifacts/frontend.pid ]; then kill $(cat .artifacts/frontend.pid) || true; fi
          if [ -f .artifacts/backend.pid ]; then kill $(cat .artifacts/backend.pid) || true; fi

      - name: Dump logs on failure
        if: failure()
        run: |
          echo '--- backend.log ---'
          cat .artifacts/backend.log || true
          echo '--- frontend.log ---'
          cat .artifacts/frontend.log || true

      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: invite-e2e-logs
          path: |
            .artifacts/backend.log
            .artifacts/frontend.log
