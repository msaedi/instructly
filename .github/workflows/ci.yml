name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  contract-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python for OpenAPI export (frontend contract audit reads this)
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements-openapi.txt

      - name: Install Python deps for OpenAPI export
        working-directory: backend
        run: pip install -r requirements-openapi.txt

      # Node for contract check
      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Show Node versions (debug)
        run: node -v && npm -v

      - name: Contract check
        working-directory: frontend
        run: node scripts/contract-check.mjs

  lint-build:
    needs: contract-check
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      STG_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      PROD_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
    services:
      postgres:
        image: ghcr.io/msaedi/instructly-ci-postgres:14-postgis-pgvector
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: instainstru_test
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Show Node versions (debug)
        run: node -v && npm -v

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint
        working-directory: frontend
        run: npm run lint:ci

      - name: Verify public env usage
        working-directory: frontend
        run: npm run verify:public-env

      - name: Typecheck
        working-directory: frontend
        run: npm run typecheck:strict

      - name: Response-model strict audit (hard)
        run: python tools/audit_response_model_strict.py

      - name: Knip dead code check (hard fail)
        working-directory: frontend
        run: |
          npx knip --reporter=json > .artifacts/knip.json || true
          count=$(node -e "const fs=require('fs');try{const d=JSON.parse(fs.readFileSync('.artifacts/knip.json','utf8'));console.log(Array.isArray(d)?d.length:(d.issues?d.issues.length:0));}catch{console.log(0)}")
          echo "Knip count: ${count}"
          if [ "${count}" -gt 0 ]; then
            echo "❌ Dead code detected (${count})"
            exit 1
          fi
          echo "✅ No dead code"

      - name: Contract audit (guardrail)
        working-directory: frontend
        run: npm run audit:contract:ci

      - name: Read audit metrics
        id: audit
        working-directory: frontend
        run: |
          jq -r '. as $j | "drift=\($j.drift)\noutside=\($j.directImports.outsideAllowed)\nvia=\($j.viaShimCount)"' .artifacts/contract-audit.json >> $GITHUB_OUTPUT

      - name: Read adoption metrics
        id: adopt
        working-directory: frontend
        run: |
          jq -r '. as $j | "adHocAny=\($j.adHocAnyCallSites)"' .artifacts/contract-adoption.json >> $GITHUB_OUTPUT

      - name: Summarize contract audit
        working-directory: frontend
        run: |
          echo "### FE⇄BE contract audit" >> $GITHUB_STEP_SUMMARY
          echo "- Drift: ${{ steps.audit.outputs.drift }}" >> $GITHUB_STEP_SUMMARY
          echo "- Direct imports (outside allowed): ${{ steps.audit.outputs.outside }}" >> $GITHUB_STEP_SUMMARY
          echo "- Imports via shim: ${{ steps.audit.outputs.via }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ad-hoc/any call-sites: ${{ steps.adopt.outputs.adHocAny }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See attached artifact for full report and adoption targets." >> $GITHUB_STEP_SUMMARY

      - name: Fail on drift or forbidden direct imports
        if: steps.audit.outputs.drift == 'true' || steps.audit.outputs.outside != '0'
        run: |
          echo "❌ Contract guardrail failed: drift or forbidden direct imports detected."
          exit 1

      - name: Warn if shim adoption below target
        if: steps.audit.outputs.via < 20
        run: echo "⚠️ Shim adoption below target (20); consider wiring more call sites."

      - name: Warn if ad-hoc/any call-sites detected
        if: steps.adopt.outputs.adHocAny != '0'
        run: echo "⚠️ Found ${{ steps.adopt.outputs.adHocAny }} ad-hoc/any API call-sites (see adoption artifacts)."

      - name: Upload contract audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contract-audit
          path: |
            frontend/.artifacts/contract-audit.json
            frontend/.artifacts/contract-audit-report.md
            frontend/.artifacts/contract-adoption.json
            frontend/.artifacts/contract-adoption.md

      - name: Guardrail #12 – enforce exact pins for codegen/test deps
        shell: bash
        working-directory: frontend
        run: |
          set -euo pipefail
          must_pin=(
            "openapi-typescript"
            "@playwright/test"
            "@axe-core/playwright"
          )
          for pkg in "${must_pin[@]}"; do
            ver="$(jq -r --arg k "$pkg" '.dependencies[$k] // .devDependencies[$k] // ""' package.json)"
            if [ -z "${ver}" ]; then
              echo "warn: ${pkg} not found; skipping"
              continue
            fi
            if [[ ! "${ver}" =~ ^[0-9]+(\.[0-9]+)*(-[0-9A-Za-z.]+)?$ ]]; then
              echo "error: ${pkg} must be exactly pinned, found \"${ver}\""
              exit 1
            fi
            echo "ok: ${pkg} pinned to ${ver}"
          done
