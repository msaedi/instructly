name: env-contract
on: [workflow_dispatch]
jobs:
  smoke:
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      PLAYWRIGHT_BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL || vars.PLAYWRIGHT_BASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
        working-directory: frontend
      - name: Run Playwright smoke
        working-directory: frontend
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        run: npx playwright test tests/env-contract.spec.ts --reporter=line
      - name: Summarize endpoint statuses
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "$PLAYWRIGHT_BASE_URL/health" || true)
          OPENAPI=$(curl -s -o /dev/null -w "%{http_code}" "$PLAYWRIGHT_BASE_URL/openapi.json" || true)
          echo "health: $HEALTH" > .artifacts/env-contract-summary.txt
          echo "openapi.json: $OPENAPI" >> .artifacts/env-contract-summary.txt
      - name: Upload env-contract artifact
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: env-contract
          path: .artifacts/env-contract-summary.txt
      - name: Skip (no base URL provided)
        if: ${{ env.PLAYWRIGHT_BASE_URL == '' }}
        run: echo "PLAYWRIGHT_BASE_URL not set; skipping"
