name: env-contract
on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Base URL (defaults to PREVIEW_BASE_URL)"
        required: false
        type: string
      api_base_url:
        description: "API Base URL (defaults to PREVIEW_API_BASE_URL)"
        required: false
        type: string
      beta_code:
        description: "One-time beta code (only when testing beta)"
        required: false
        type: string
      E2E_HEADERS_TEST:
        description: "Enable header/CORS checks (1 to enable)"
        required: false
        default: "0"
      E2E_RATE_LIMIT_TEST:
        description: "Enable 429 dedupe check (1 to enable)"
        required: false
        default: "0"
      allowed_phases:
        description: "Comma-separated allowed X-Phase values"
        required: false
        type: string
      api_only:
        description: "Run without UI/staff gate (1 = API-only preview)"
        required: false
        default: "0"
  schedule:
    - cron: "0 9 * * *"
jobs:
  smoke:
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      PLAYWRIGHT_BASE_URL: ${{ (github.event_name == 'schedule' && vars.PREVIEW_BASE_URL) || inputs.base_url || vars.PREVIEW_BASE_URL }}
      PLAYWRIGHT_API_BASE_URL: ${{ (github.event_name == 'schedule' && vars.PREVIEW_API_BASE_URL) || inputs.api_base_url || vars.PREVIEW_API_BASE_URL }}
      GATE_CODE: ${{ ((github.event_name == 'schedule') || inputs.api_only == '1') && '' || inputs.beta_code || secrets.PREVIEW_STAFF_CODE }}
      E2E_HEADERS_TEST: ${{ ((github.event_name == 'schedule') || inputs.api_only == '1') && '1' || inputs.E2E_HEADERS_TEST }}
      E2E_RATE_LIMIT_TEST: ${{ ((github.event_name == 'schedule') || inputs.api_only == '1') && '1' || inputs.E2E_RATE_LIMIT_TEST }}
      ALLOWED_PHASES: ${{ ((github.event_name == 'schedule') || inputs.api_only == '1') && (vars.ALLOWED_PHASES || 'instructor_only,beta,open') || inputs.allowed_phases || 'beta,open,instructor_only,instructor-only' }}
      API_ONLY: ${{ (github.event_name == 'schedule' || inputs.api_only == '1') && '1' || '0' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "22" }
      - name: Install dependencies
        run: npm ci
        working-directory: frontend
      - name: Install Playwright browsers
        working-directory: frontend
        run: npx --yes playwright install --with-deps
      - name: Run Playwright tests
        working-directory: frontend
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}
          GATE_CODE: ${{ env.GATE_CODE }}
          E2E_HEADERS_TEST: ${{ env.E2E_HEADERS_TEST }}
          E2E_RATE_LIMIT_TEST: ${{ env.E2E_RATE_LIMIT_TEST }}
          API_ONLY: ${{ env.API_ONLY }}
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          npx --yes playwright test e2e/env-contract.spec.ts --reporter=line | tee .artifacts/playwright.log
      - name: Summarize endpoint statuses
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "$PLAYWRIGHT_BASE_URL/health" || true)
          OPENAPI=$(curl -s -o /dev/null -w "%{http_code}" "$PLAYWRIGHT_BASE_URL/openapi.json" || true)
          echo "health: $HEALTH" > .artifacts/env-contract-summary.txt
          echo "openapi.json: $OPENAPI" >> .artifacts/env-contract-summary.txt
      - name: Collect env-contract evidence
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          {
            echo "run_url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}";
            if [ -f .artifacts/playwright.log ]; then
              grep -E '^(\[headers]|\[cors]|\[429-triage]).*' .artifacts/playwright.log || true;
            fi
          } | tee .artifacts/env-contract-evidence.txt
      - name: Upload env-contract artifact
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: env-contract
          path: |
            .artifacts/env-contract-summary.txt
            .artifacts/env-contract-evidence.txt
      - name: Skip (no base URL provided)
        if: ${{ env.PLAYWRIGHT_BASE_URL == '' }}
        run: echo "PLAYWRIGHT_BASE_URL not set; skipping"
