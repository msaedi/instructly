name: env-contract
on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Base URL (defaults to PREVIEW_BASE_URL)"
        required: false
        type: string
      api_base_url:
        description: "API Base URL (defaults to PREVIEW_API_BASE_URL)"
        required: false
        type: string
      beta_code:
        description: "One-time beta code (only when testing beta)"
        required: false
        type: string
      E2E_HEADERS_TEST:
        description: "Enable header/CORS checks (1 to enable)"
        required: false
        default: "0"
      E2E_RATE_LIMIT_TEST:
        description: "Enable 429 dedupe check (1 to enable)"
        required: false
        default: "0"
      allowed_phases:
        description: "Comma-separated allowed X-Phase values"
        required: false
        type: string
      api_only:
        description: "Run without UI/staff gate (1 = API-only preview)"
        required: false
        default: "0"
  schedule:
    - cron: "0 9 * * *"
  push:
    paths:
      - 'backend/**'
      - 'tools/mypy_strict_gate.sh'
      - 'backend/pyproject.toml'
      - 'backend/requirements*.txt'
      - 'backend/alembic/**'
      - 'backend/typings/**'
      - '.github/workflows/**'
      - '.pre-commit-config.yaml'
      - 'frontend/**'
  pull_request:
    paths:
      - 'backend/**'
      - 'tools/mypy_strict_gate.sh'
      - 'backend/pyproject.toml'
      - 'backend/requirements*.txt'
      - 'backend/alembic/**'
      - 'backend/typings/**'
      - '.github/workflows/**'
      - '.pre-commit-config.yaml'
      - 'frontend/**'
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_BASE_URL: ${{ (github.event_name == 'schedule' && vars.PREVIEW_BASE_URL) || inputs.base_url || vars.PREVIEW_BASE_URL }}
      PLAYWRIGHT_API_BASE_URL: ${{ (github.event_name == 'schedule' && vars.PREVIEW_API_BASE_URL) || inputs.api_base_url || vars.PREVIEW_API_BASE_URL }}
      GATE_CODE: ${{ ((github.event_name == 'schedule') || inputs.api_only == '1') && '' || inputs.beta_code || secrets.PREVIEW_STAFF_CODE }}
      E2E_HEADERS_TEST: ${{ ((github.event_name == 'schedule') || inputs.api_only == '1') && '1' || inputs.E2E_HEADERS_TEST }}
      E2E_RATE_LIMIT_TEST: ${{ ((github.event_name == 'schedule') || inputs.api_only == '1') && '1' || inputs.E2E_RATE_LIMIT_TEST }}
      ALLOWED_PHASES: ${{ ((github.event_name == 'schedule') || inputs.api_only == '1') && (vars.ALLOWED_PHASES || 'instructor_only,beta,open') || inputs.allowed_phases || 'beta,open,instructor_only,instructor-only' }}
      API_ONLY: ${{ (github.event_name == 'schedule' || inputs.api_only == '1') && '1' || '0' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "22" }
      - name: Install dependencies
        run: npm ci
        working-directory: frontend
      - name: Install Playwright browsers
        working-directory: frontend
        run: npx --yes playwright install --with-deps
      - name: Run Playwright tests
        working-directory: frontend
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}
          GATE_CODE: ${{ env.GATE_CODE }}
          E2E_HEADERS_TEST: ${{ env.E2E_HEADERS_TEST }}
          E2E_RATE_LIMIT_TEST: ${{ env.E2E_RATE_LIMIT_TEST }}
          API_ONLY: ${{ env.API_ONLY }}
        run: |
          set -euo pipefail
          mkdir -p ../.artifacts
          npx --yes playwright test e2e/env-contract.spec.ts --reporter=line 2>&1 | tee ../.artifacts/pw.log
      - name: Extract env-contract evidence + write job summary (non-blocking)
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        shell: bash
        run: |
          set -uo pipefail
          mkdir -p .artifacts
          : > .artifacts/env-contract-evidence.txt
          # Parse lines we print from the Playwright test logs
          SITE_MODE=$(grep -Eo '^\[headers\] X-Site-Mode=[^ ]+' .artifacts/pw.log | head -n1 | cut -d= -f2 || true)
          PHASE=$(grep -E '^\[headers\] ' .artifacts/pw.log | head -n1 | sed -E 's/.*X-Phase=([^ ]+).*/\1/' || true)
          CORS_CREDS=$(grep -Eo '^\[cors\] access-control-allow-credentials=[^ ]+' .artifacts/pw.log | head -n1 | cut -d= -f2 || true)
          CORS_ORIGIN=$(grep -E '^\[cors\] ' .artifacts/pw.log | head -n1 | sed -E 's/.*access-control-allow-origin=//' || true)
          DEDUPE=$(grep -Eo '^\[429-triage\] dedupeKey=[^ ]+' .artifacts/pw.log | head -n1 | cut -d= -f2 || true)
          LIMITED=$(grep -E '^\[429-triage\] ' .artifacts/pw.log | head -n1 | sed -E 's/.*limited=([0-9]+).*/\1/' || true)
          ATTEMPTS=$(grep -E '^\[429-triage\] ' .artifacts/pw.log | head -n1 | sed -E 's/.*attempts=([0-9]+).*/\1/' || true)

          {
            echo "[headers] X-Site-Mode=${SITE_MODE:-} X-Phase=${PHASE:-}"
            echo "[cors] access-control-allow-credentials=${CORS_CREDS:-} access-control-allow-origin=${CORS_ORIGIN:-}"
            echo "[429-triage] dedupeKey=${DEDUPE:-} limited=${LIMITED:-} attempts=${ATTEMPTS:-}"
          } | tee .artifacts/env-contract-evidence.txt

          {
            echo "### Env-Contract Evidence"
            echo
            echo '```text'
            cat .artifacts/env-contract-evidence.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

          # Soft alerts (non-blocking): missing or surprising values
          warn=0
          for v in SITE_MODE PHASE CORS_CREDS CORS_ORIGIN DEDUPE LIMITED ATTEMPTS; do
            if [ -z "${!v:-}" ]; then
              echo "::warning title=env-contract::Missing value for $v (non-blocking)"
              warn=1
            fi
          done

          if [ -n "${LIMITED:-}" ] && [ "$LIMITED" -eq 0 ]; then
            echo "::warning title=env-contract::No 429s observed; rate-limit probe may be inactive (non-blocking)"
          fi
          if [ -n "${LIMITED:-}" ] && [ "$LIMITED" -gt 1 ]; then
            echo "::warning title=env-contract::Multiple 429s observed (limited=$LIMITED); dedupe may be off (non-blocking)"
          fi

          # Always succeed; this step is informational by design
          exit 0
      - name: Summarize endpoint statuses
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "$PLAYWRIGHT_BASE_URL/health" || true)
          OPENAPI=$(curl -s -o /dev/null -w "%{http_code}" "$PLAYWRIGHT_BASE_URL/openapi.json" || true)
          echo "health: $HEALTH" > .artifacts/env-contract-summary.txt
          echo "openapi.json: $OPENAPI" >> .artifacts/env-contract-summary.txt
      - name: Upload env-contract evidence
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: env-contract-evidence
          path: |
            .artifacts/env-contract-evidence.txt
            .artifacts/pw.log
          if-no-files-found: warn
          retention-days: 30
      - name: Alert on missing/limited env-contract evidence
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          # Evidence files created earlier in this workflow:
          #   - .artifacts/pw.log
          #   - .artifacts/env-contract-evidence.txt (also check root fallback)
          LOG_FILES=(".artifacts/pw.log" ".artifacts/env-contract-evidence.txt" "env-contract-evidence.txt")

          found_headers=""
          found_cors=""
          found_triage=""
          triage_line=""

          for f in "${LOG_FILES[@]}"; do
            [ -f "$f" ] || continue
            [ -n "$found_headers" ] || found_headers="$(grep -m1 '^\[headers\]' "$f" || true)"
            [ -n "$found_cors" ]    || found_cors="$(grep -m1 '^\[cors\]' "$f" || true)"
            [ -n "$found_triage" ]  || found_triage="$(grep -m1 '^\[429-triage\]' "$f" || true)"
          done

          warn=0
          if [ -z "$found_headers" ] || [ -z "$found_cors" ] || [ -z "$found_triage" ]; then
            warn=1
            msg="env-contract evidence missing line(s): headers=${found_headers:+present} cors=${found_cors:+present} triage=${found_triage:+present}"
          else
            triage_line="$found_triage"
            limited=$(echo "$triage_line" | sed -n 's/.*limited=\([0-9]\+\).*/\1/p')
            limited=${limited:-0}
            if [ "$limited" -eq 0 ]; then
              warn=1
              msg="env-contract triage limited==0 (no 429 observed)"
            else
              msg="env-contract OK"
            fi
          fi

          echo "Summary: $msg"
          echo "Headers: $found_headers"
          echo "CORS:    $found_cors"
          echo "429:     $found_triage"

          if [ "$warn" -eq 1 ]; then
            # Slack if configured
            if [ -n "${{ secrets.SLACK_WEBHOOK_URL || '' }}" ]; then
              payload=$(jq -n \
                --arg text ":warning: env-contract ${{ github.workflow }} run needs attention for ${{ github.ref_name }} (${{ github.run_id }}). $msg" \
                --arg headers "$found_headers" \
                --arg cors "$found_cors" \
                --arg triage "$found_triage" \
                '{text: $text, attachments: [ { color: "#ffcc00", fields: [ { title: "headers", value: $headers, short: true }, { title: "cors", value: $cors, short: true }, { title: "429-triage", value: $triage, short: true } ] } ] }')
              curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "${{ secrets.SLACK_WEBHOOK_URL }}" >/dev/null || true
            else
              # Fallback: create an issue comment on the repo with a brief message
              gh issue create --title "env-contract evidence warning" \
                --body "Workflow: \`${GITHUB_WORKFLOW}\` Run: ${{ github.run_id }} Ref: \`${{ github.ref_name }}\`.\n\n$msg\n\nheaders: \`$found_headers\`\ncors: \`$found_cors\`\ntriage: \`$found_triage\`" \
                || true
            fi
          fi
      - name: Skip (no base URL provided)
        if: ${{ env.PLAYWRIGHT_BASE_URL == '' }}
        run: echo "PLAYWRIGHT_BASE_URL not set; skipping"
  beta-api:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_BASE_URL: ${{ vars.BETA_BASE_URL }}
      PLAYWRIGHT_API_BASE_URL: ${{ vars.BETA_API_BASE_URL }}
      GATE_CODE: ''
      E2E_HEADERS_TEST: '1'
      E2E_RATE_LIMIT_TEST: '1'
      ALLOWED_PHASES: ${{ inputs.allowed_phases || vars.ALLOWED_PHASES || 'beta,open,instructor_only' }}
      API_ONLY: '1'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "22" }
      - name: Install dependencies
        run: npm ci
        working-directory: frontend
      - name: Install Playwright browsers
        working-directory: frontend
        run: npx --yes playwright install --with-deps
      - name: Run Playwright tests
        working-directory: frontend
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}
          PLAYWRIGHT_API_BASE_URL: ${{ env.PLAYWRIGHT_API_BASE_URL }}
          E2E_HEADERS_TEST: ${{ env.E2E_HEADERS_TEST }}
          E2E_RATE_LIMIT_TEST: ${{ env.E2E_RATE_LIMIT_TEST }}
          API_ONLY: ${{ env.API_ONLY }}
        run: |
          set -euo pipefail
          mkdir -p ../.artifacts
          npx --yes playwright test e2e/env-contract.spec.ts --reporter=line 2>&1 | tee ../.artifacts/pw.log
      - name: Extract env-contract evidence + write job summary (non-blocking)
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        shell: bash
        run: |
          set -uo pipefail
          mkdir -p .artifacts
          : > .artifacts/env-contract-evidence.txt

          # Parse lines we print from the Playwright test logs
          SITE_MODE=$(grep -Eo '^\[headers\] X-Site-Mode=[^ ]+' .artifacts/pw.log | head -n1 | cut -d= -f2 || true)
          PHASE=$(grep -E '^\[headers\] ' .artifacts/pw.log | head -n1 | sed -E 's/.*X-Phase=([^ ]+).*/\1/' || true)
          CORS_CREDS=$(grep -Eo '^\[cors\] access-control-allow-credentials=[^ ]+' .artifacts/pw.log | head -n1 | cut -d= -f2 || true)
          CORS_ORIGIN=$(grep -E '^\[cors\] ' .artifacts/pw.log | head -n1 | sed -E 's/.*access-control-allow-origin=//' || true)
          DEDUPE=$(grep -Eo '^\[429-triage\] dedupeKey=[^ ]+' .artifacts/pw.log | head -n1 | cut -d= -f2 || true)
          LIMITED=$(grep -E '^\[429-triage\] ' .artifacts/pw.log | head -n1 | sed -E 's/.*limited=([0-9]+).*/\1/' || true)
          ATTEMPTS=$(grep -E '^\[429-triage\] ' .artifacts/pw.log | head -n1 | sed -E 's/.*attempts=([0-9]+).*/\1/' || true)

          {
            echo "[headers] X-Site-Mode=${SITE_MODE:-} X-Phase=${PHASE:-}"
            echo "[cors] access-control-allow-credentials=${CORS_CREDS:-} access-control-allow-origin=${CORS_ORIGIN:-}"
            echo "[429-triage] dedupeKey=${DEDUPE:-} limited=${LIMITED:-} attempts=${ATTEMPTS:-}"
          } | tee .artifacts/env-contract-evidence.txt

          {
            echo "### Env-Contract Evidence"
            echo
            echo '```text'
            cat .artifacts/env-contract-evidence.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

          # Soft alerts (non-blocking): missing or surprising values
          warn=0
          for v in SITE_MODE PHASE CORS_CREDS CORS_ORIGIN DEDUPE LIMITED ATTEMPTS; do
            if [ -z "${!v:-}" ]; then
              echo "::warning title=env-contract::Missing value for $v (non-blocking)"
              warn=1
            fi
          done

          if [ -n "${LIMITED:-}" ] && [ "$LIMITED" -eq 0 ]; then
            echo "::warning title=env-contract::No 429s observed; rate-limit probe may be inactive (non-blocking)"
          fi
          if [ -n "${LIMITED:-}" ] && [ "$LIMITED" -gt 1 ]; then
            echo "::warning title=env-contract::Multiple 429s observed (limited=$LIMITED); dedupe may be off (non-blocking)"
          fi

          # Always succeed; this step is informational by design
          exit 0
      - name: Summarize endpoint statuses
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "$PLAYWRIGHT_BASE_URL/health" || true)
          OPENAPI=$(curl -s -o /dev/null -w "%{http_code}" "$PLAYWRIGHT_BASE_URL/openapi.json" || true)
          echo "health: $HEALTH" > .artifacts/env-contract-summary.txt
          echo "openapi.json: $OPENAPI" >> .artifacts/env-contract-summary.txt
      - name: Upload env-contract evidence (beta)
        if: ${{ env.PLAYWRIGHT_BASE_URL != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: env-contract-evidence-beta
          path: |
            .artifacts/env-contract-evidence.txt
            .artifacts/pw.log
          if-no-files-found: warn
          retention-days: 30
      - name: Alert on missing/limited env-contract evidence
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          # Evidence files created earlier in this workflow:
          #   - .artifacts/pw.log
          #   - .artifacts/env-contract-evidence.txt (also check root fallback)
          LOG_FILES=(".artifacts/pw.log" ".artifacts/env-contract-evidence.txt" "env-contract-evidence.txt")

          found_headers=""
          found_cors=""
          found_triage=""
          triage_line=""

          for f in "${LOG_FILES[@]}"; do
            [ -f "$f" ] || continue
            [ -n "$found_headers" ] || found_headers="$(grep -m1 '^\[headers\]' "$f" || true)"
            [ -n "$found_cors" ]    || found_cors="$(grep -m1 '^\[cors\]' "$f" || true)"
            [ -n "$found_triage" ]  || found_triage="$(grep -m1 '^\[429-triage\]' "$f" || true)"
          done

          warn=0
          if [ -z "$found_headers" ] || [ -z "$found_cors" ] || [ -z "$found_triage" ]; then
            warn=1
            msg="env-contract evidence missing line(s): headers=${found_headers:+present} cors=${found_cors:+present} triage=${found_triage:+present}"
          else
            triage_line="$found_triage"
            limited=$(echo "$triage_line" | sed -n 's/.*limited=\([0-9]\+\).*/\1/p')
            limited=${limited:-0}
            if [ "$limited" -eq 0 ]; then
              warn=1
              msg="env-contract triage limited==0 (no 429 observed)"
            else
              msg="env-contract OK"
            fi
          fi

          echo "Summary: $msg"
          echo "Headers: $found_headers"
          echo "CORS:    $found_cors"
          echo "429:     $found_triage"

          if [ "$warn" -eq 1 ]; then
            # Slack if configured
            if [ -n "${{ secrets.SLACK_WEBHOOK_URL || '' }}" ]; then
              payload=$(jq -n \
                --arg text ":warning: env-contract ${{ github.workflow }} run needs attention for ${{ github.ref_name }} (${{ github.run_id }}). $msg" \
                --arg headers "$found_headers" \
                --arg cors "$found_cors" \
                --arg triage "$found_triage" \
                '{text: $text, attachments: [ { color: "#ffcc00", fields: [ { title: "headers", value: $headers, short: true }, { title: "cors", value: $cors, short: true }, { title: "429-triage", value: $triage, short: true } ] } ] }')
              curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "${{ secrets.SLACK_WEBHOOK_URL }}" >/dev/null || true
            else
              # Fallback: create an issue comment on the repo with a brief message
              gh issue create --title "env-contract evidence warning" \
                --body "Workflow: \`${GITHUB_WORKFLOW}\` Run: ${{ github.run_id }} Ref: \`${{ github.ref_name }}\`.\n\n$msg\n\nheaders: \`$found_headers\`\ncors: \`$found_cors\`\ntriage: \`$found_triage\`" \
                || true
            fi
          fi
      - name: Skip (no base URL provided)
        if: ${{ env.PLAYWRIGHT_BASE_URL == '' }}
        run: echo "PLAYWRIGHT_BASE_URL not set; skipping"
