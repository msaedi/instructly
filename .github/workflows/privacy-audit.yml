name: Privacy Protection Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

# (optional but recommended)
concurrency:
  group: privacy-audit-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read
  checks: write
  pull-requests: write

env:
  NODE_VERSION: '22'
  DB_IMAGE: ghcr.io/msaedi/instructly-ci-postgres@sha256:dd6c9450465b6fc753e084f870df22307bfddd150b14a660bf28fd786c9acc58
  # no-op bump demo; digest unchanged

jobs:
  privacy-check:
    runs-on: ubuntu-latest
    env:
      SITE_MODE: int
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      STG_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
      PROD_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/instainstru_test
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          check-latest: true
          cache: npm

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ./.python-version
          cache: 'pip'

      - name: Check disk usage (before backend deps)
        run: df -h

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install --no-cache-dir httpx pyyaml

      - name: Check disk usage (after backend deps)
        run: df -h

      - name: Login to GHCR (actor + GITHUB_TOKEN)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: GHCR fallback login (PAT, optional)
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        if: ${{ env.GHCR_PAT != '' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: msaedi
          password: ${{ env.GHCR_PAT }}

      - name: Pre-pull DB image (fail fast)
        run: |
          set -e
          docker pull "${{ env.DB_IMAGE }}"

      - name: Start services (pgvector image)
        run: |
          cat > compose.privacy.yml <<'YML'
          services:
            db:
              image: ${DB_IMAGE}
              environment:
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: postgres
                POSTGRES_DB: appdb
              ports:
                - "5432:5432"
              healthcheck:
                test: ["CMD-SHELL","pg_isready -U postgres"]
                interval: 5s
                timeout: 5s
                retries: 20
            redis:
              image: redis:7-alpine
          YML
          DB_IMAGE="${{ env.DB_IMAGE }}" docker compose -f compose.privacy.yml up -d
          docker compose -f compose.privacy.yml ps

      - name: Show resolved compose config
        run: |
          echo '--- docker compose config (db only) ---'
          docker compose -f compose.privacy.yml config | sed -n '/services:/,/^$/p' | sed -n '/db:/,/^[^[:space:]]/p'

      - name: Guard DB image is GHCR
        run: |
          RESOLVED=$(docker compose -f compose.privacy.yml config | sed -n '/db:/,/^[^[:space:]]/p' | grep -E "^[[:space:]]*image:" | awk '{print $2}')
          echo "Resolved DB image: $RESOLVED"
          if ! echo "$RESOLVED" | grep -q '^ghcr.io/msaedi/instructly-ci-postgres@sha256:dd6c9450465b6fc753e084f870df22307bfddd150b14a660bf28fd786c9acc58$'; then
            echo "DB image is not the GHCR image. Failing as per guard policy."
            exit 1
          fi

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Wait for DB (health-gated)
        id: wait_db
        run: |
          set -e
          CID="$(docker compose -f compose.privacy.yml ps -q db)"
          echo "db container: $CID"
          for i in {1..90}; do
            STATUS="$(docker inspect -f '{{.State.Health.Status}}' "$CID" || echo "unknown")"
            echo "db health: $STATUS"
            if [ "$STATUS" = "healthy" ]; then
              break
            fi
            sleep 2
          done
          if [ "$STATUS" != "healthy" ]; then
            echo "DB never became healthy"
            docker compose -f compose.privacy.yml logs db | tail -n 300
            exit 1
          fi

      - name: Wait until queries succeed
        run: |
          set -e
          for i in {1..60}; do
            if docker compose -f compose.privacy.yml exec -T \
                 -e PGPASSWORD=postgres db \
                 psql -h 127.0.0.1 -U postgres -d appdb -c "SELECT 1" >/dev/null 2>&1; then
              echo "DB query-ready"
              exit 0
            fi
            echo "waiting for DB query-ready..."
            sleep 2
          done
          echo "DB failed to become query-ready"
          docker compose -f compose.privacy.yml logs db | tail -n 300
          exit 1

      - name: Verify pgvector is available
        run: |
          docker compose -f compose.privacy.yml exec -T \
            -e PGPASSWORD=postgres db \
            psql -h 127.0.0.1 -U postgres -d appdb -c \
            "SELECT name, default_version FROM pg_available_extensions WHERE name='vector';"

      - name: Confirm extensions installed
        run: |
          docker compose -f compose.privacy.yml exec -T \
            -e PGPASSWORD=postgres db \
            psql -h 127.0.0.1 -U postgres -d appdb -c "SELECT postgis_full_version();"
          docker compose -f compose.privacy.yml exec -T \
            -e PGPASSWORD=postgres db \
            psql -h 127.0.0.1 -U postgres -d appdb -c \
            "SELECT name, default_version FROM pg_available_extensions WHERE name='vector';"

      - name: Ensure test database exists
        run: |
          psql "postgresql://postgres:postgres@localhost:5432/postgres" -tAc "SELECT 1 FROM pg_database WHERE datname = 'instainstru_test'" | grep -q 1 \
            || psql "postgresql://postgres:postgres@localhost:5432/postgres" -c "CREATE DATABASE instainstru_test"

      - name: Migrate schema
        working-directory: backend
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: python scripts/prep_db.py int --migrate --force --yes

      - name: Ensure region_boundaries unique index
        working-directory: backend
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          python - <<'PY'
          import os
          import psycopg2

          conn = psycopg2.connect(os.environ['DATABASE_URL'])
          cur = conn.cursor()
          cur.execute(
              """
              DO $$
              BEGIN
                IF EXISTS (
                  SELECT 1
                  FROM information_schema.tables
                  WHERE table_schema = 'public' AND table_name = 'region_boundaries'
                ) THEN
                  CREATE UNIQUE INDEX IF NOT EXISTS region_boundaries_rtype_rcode_idx
                    ON region_boundaries(region_type, region_code);
                END IF;
              END $$;
              """
          )
          conn.commit()
          cur.close()
          conn.close()
          PY

      - name: Seed test data
        working-directory: backend
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: python scripts/prep_db.py int --seed-all --force --yes

      - name: Start backend server
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/appdb
          USE_TEST_DATABASE: true
          REDIS_URL: redis://localhost:6379/0
        run: |
          cd backend
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 10

      - name: Run privacy audit
        id: audit
        env:
          API_BASE_URL: http://localhost:8000
          SKIP_ENV_CHECK: true
          PRIVACY_DEEP_SCAN: ${{ vars.PRIVACY_DEEP_SCAN || '' }}
        run: |
          cd backend
          VERBOSE_FLAG=""
          CATEGORY_FLAG=""
          if [[ "${{ github.event.inputs.verbose }}" == "true" ]]; then
            VERBOSE_FLAG="--verbose"
          fi
          if [[ -n "${{ github.event.inputs.category }}" ]]; then
            CATEGORY_FLAG="--category ${{ github.event.inputs.category }}"
          fi
          python scripts/ci_privacy_audit.py --ci $VERBOSE_FLAG $CATEGORY_FLAG
        continue-on-error: true

      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: privacy-audit-reports-${{ github.run_number }}
          path: |
            backend/logs/privacy_audit_report.json
            backend/logs/privacy_audit_report.md
          retention-days: 30

      - name: Read audit results
        if: always()
        id: results
        run: |
          if [ -f backend/logs/privacy_audit_report.json ]; then
            VIOLATIONS=$(jq '.violations | length' backend/logs/privacy_audit_report.json)
            echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
            HIGH_SEVERITY=$(jq '[.violations[] | select(.severity == "HIGH")] | length' backend/logs/privacy_audit_report.json)
            echo "high_severity=$HIGH_SEVERITY" >> $GITHUB_OUTPUT
          else
            echo "violations=0" >> $GITHUB_OUTPUT
            echo "high_severity=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            let comment = '## üîí Privacy Audit Results\n\n';
            const reportPath = path.join('backend', 'logs', 'privacy_audit_report.md');
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              comment += report;
            } else {
              comment += '‚úÖ Privacy audit completed successfully with no violations found.';
            }
            comment += '\n\n---\n';
            comment += `üìé [View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            comment += `üîç Run triggered by: ${{ github.event_name }}`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('Privacy Audit Results'));
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Set check status
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const violations = ${{ steps.results.outputs.violations || 0 }};
            const highSeverity = ${{ steps.results.outputs.high_severity || 0 }};
            let conclusion = 'success';
            let title = '‚úÖ No privacy violations found';
            let summary = 'All endpoints passed privacy compliance checks.';
            if (highSeverity > 0) {
              conclusion = 'failure';
              title = `‚ùå ${highSeverity} high-severity privacy violations found`;
              summary = `Found ${violations} total violations, including ${highSeverity} high-severity issues that must be fixed.`;
            } else if (violations > 0) {
              conclusion = 'neutral';
              title = `‚ö†Ô∏è ${violations} privacy violations found (no high severity)`;
              summary = `Found ${violations} violations, but none are high severity. Consider fixing before merge.`;
            }
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Privacy Compliance',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: { title, summary }
            });

      - name: Stop services
        if: always()
        run: |
          docker compose -f compose.privacy.yml down -v || true
          pkill -f uvicorn || true
