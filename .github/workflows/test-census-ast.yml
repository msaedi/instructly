name: Test Census (AST)
on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch/tag/sha to analyze"
        required: true
        default: "perf/availability-baseline-20251026"

jobs:
  census-ast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run AST census
        run: |
          cat > test_census.py << 'PY'
          # (tiny AST counter; counts test_* & parametrization)
          import ast, sys
          from pathlib import Path
          def cases(dec):
              try:
                  if len(dec.args) >= 2 and isinstance(dec.args[1], (ast.List, ast.Tuple)):
                      return max(1, len(dec.args[1].elts))
              except Exception: pass
              return 1
          def is_parametrize(d):
              try:
                  f=d.func
                  parts=[]
                  while isinstance(f, ast.Attribute):
                      parts.append(f.attr); f=f.value
                  if isinstance(f, ast.Name): parts.append(f.id)
                  dotted=".".join(reversed(parts))
                  return "parametrize" in dotted
              except Exception: return False
          def count(fn):
              if not fn.name.startswith("test_"): return 0
              mult=1
              for d in fn.decorator_list or []:
                  if isinstance(d, ast.Call) and is_parametrize(d): mult*=cases(d)
              return mult
          def bucket(p):
              parts=Path(p).parts
              if "integration" in parts and "repository_patterns" in parts: return "repo_patterns"
              if "integration" in parts: return "integration"
              if "unit" in parts: return "unit"
              if "routes" in parts: return "routes"
              if "repositories" in parts: return "repositories"
              if "scripts" in parts: return "scripts"
              return "other"
          totals = {"total":0,"by_bucket":{}}
          for py in Path("backend/tests").rglob("*.py"):
              try: src=py.read_text(encoding="utf-8", errors="ignore")
              except: continue
              try: tree=ast.parse(src)
              except SyntaxError: continue
              n=0
              for n1 in tree.body:
                  if isinstance(n1, ast.FunctionDef): n+=count(n1)
                  elif isinstance(n1, ast.ClassDef) and n1.name.startswith("Test"):
                      for m in n1.body:
                          if isinstance(m, ast.FunctionDef): n+=count(m)
              if n:
                  b=bucket(str(py)); totals["by_bucket"][b]=totals["by_bucket"].get(b,0)+n
                  totals["total"]+=n
          print("## AST-based Test Census")
          print(f"ref: {sys.argv[1] if len(sys.argv)>1 else 'HEAD'}")
          print("| Bucket | Count |")
          print("|---|---:|")
          print(f"| ALL | {totals['total']} |")
          for k in ["integration","unit","routes","repositories","repo_patterns","scripts","other"]:
              print(f"| {k} | {totals['by_bucket'].get(k,0)} |")
          PY
          python test_census.py "${{ github.event.inputs.ref }}" > census_ast.md
          echo "### AST Census for \`${{ github.event.inputs.ref }}\`" >> $GITHUB_STEP_SUMMARY
          cat census_ast.md >> $GITHUB_STEP_SUMMARY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: census-ast-${{ github.event.inputs.ref }}
          path: census_ast.md
