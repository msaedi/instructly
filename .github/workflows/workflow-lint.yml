name: Workflow Lint

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Lint workflows (no docker-compose v1; stable DB image)
        run: |
          set -euo pipefail

          # Find docker-compose only in other workflow files and only in non-comment lines
          offenders=$(grep -R --line-number --exclude=workflow-lint.yml -e 'docker-compose' .github/workflows || true)
          if [ -n "$offenders" ]; then
            offenders=$(echo "$offenders" | awk -F: '$3 !~ /^[[:space:]]*#/')
          fi
          if [ -n "$offenders" ]; then
            echo "Found legacy docker-compose usage in workflows:"
            echo "$offenders"
            exit 1
          fi

          # Guard: privacy audit must reference the GHCR DB image
          if ! grep -q 'ghcr.io/msaedi/instructly-ci-postgres:14-postgis-pgvector' .github/workflows/privacy-audit.yml; then
            echo "[workflow-lint] privacy-audit.yml DB image is not the GHCR image" >&2
            exit 1
          fi
