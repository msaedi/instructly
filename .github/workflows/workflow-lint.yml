name: Workflow Lint

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Lint workflows (no docker-compose v1; stable DB image)
        run: |
          set -euo pipefail

          # Find docker-compose only in other workflow files and only in non-comment lines
          offenders=$(grep -R --line-number --exclude=workflow-lint.yml -e 'docker-compose' .github/workflows || true)
          if [ -n "$offenders" ]; then
            offenders=$(echo "$offenders" | awk -F: '$3 !~ /^[[:space:]]*#/')
          fi
          if [ -n "$offenders" ]; then
            echo "Found legacy docker-compose usage in workflows:"
            echo "$offenders"
            exit 1
          fi

          # Guard: privacy audit must reference the pinned GHCR DB image digest
          if ! grep -q 'ghcr.io/msaedi/instructly-ci-postgres@sha256:dd6c9450465b6fc753e084f870df22307bfddd150b14a660bf28fd786c9acc58' .github/workflows/privacy-audit.yml; then
            echo "[workflow-lint] privacy-audit.yml DB image is not pinned by digest" >&2
            exit 1
          fi

      - name: Verify Privacy workflow triggers and DB_IMAGE digest
        run: |
          python - <<'PY'
          import sys
          try:
              import yaml  # type: ignore
          except Exception:
              yaml = None
          def bad(msg):
              print(f"[workflow-lint] {msg}", file=sys.stderr); sys.exit(1)
          text = open('.github/workflows/privacy-audit.yml','r',encoding='utf-8').read()
          data = {}
          if yaml is not None:
              data = yaml.safe_load(text) or {}
          # PyYAML (YAML 1.1) may parse the key 'on' as boolean True; handle both
          on_ = (data.get('on') if isinstance(data, dict) else None) or (data.get(True) if isinstance(data, dict) else None) or {}
          # If YAML parsing unavailable, do naive text checks
          if not on_:
              if 'on:' not in text or '\n  push:' not in text or 'branches: [ main ]' not in text or '\n  pull_request:' not in text:
                  bad('missing push/pull_request triggers for main in privacy-audit.yml (text scan)')
          else:
              push = on_.get('push') or {}
              pr = on_.get('pull_request') or {}
              push_branches = set(push.get('branches') or [])
              pr_branches = set(pr.get('branches') or [])
              if 'main' not in push_branches:
                  bad('missing push trigger for main in privacy-audit.yml')
              if 'main' not in pr_branches:
                  bad('missing pull_request trigger for main in privacy-audit.yml')
          env = (data.get('env') if isinstance(data, dict) else None) or {}
          expected = 'ghcr.io/msaedi/instructly-ci-postgres@sha256:dd6c9450465b6fc753e084f870df22307bfddd150b14a660bf28fd786c9acc58'
          db_image = env.get('DB_IMAGE') if isinstance(env, dict) else None
          if db_image != expected and expected not in text:
              bad(f"DB_IMAGE mismatch: {db_image}")
          print('[workflow-lint] privacy triggers and DB_IMAGE digest OK')
          PY
