name: OWASP ZAP Scan

on:
  schedule:
    - cron: '0 4 * * 0'  # Weekly on Sunday at 4am UTC
  workflow_dispatch:
    inputs:
      target:
        description: "Which environment to scan"
        required: false
        default: "preview"
        type: choice
        options: [preview, beta]

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Determine target URL
        id: target
        env:
          INPUT_TARGET: ${{ github.event.inputs.target }}
        run: |
          if [ "$INPUT_TARGET" = "beta" ]; then
            echo "url=https://beta-api.instainstru.com" >> $GITHUB_OUTPUT
            echo "env=beta" >> $GITHUB_OUTPUT
          else
            echo "url=https://preview-api.instainstru.com" >> $GITHUB_OUTPUT
            echo "env=preview" >> $GITHUB_OUTPUT
          fi

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: ${{ steps.target.outputs.url }}
          rules_file_name: '.zap/rules.tsv'
          allow_issue_writing: false
          fail_action: false  # Don't fail build, just report
        continue-on-error: true

      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-${{ steps.target.outputs.env }}-${{ github.run_number }}
          path: report_html.html
          retention-days: 30

      - name: Summarize ZAP Results
        if: always()
        env:
          TARGET_URL: ${{ steps.target.outputs.url }}
          TARGET_ENV: ${{ steps.target.outputs.env }}
        run: |
          echo "## OWASP ZAP Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: $TARGET_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f report_html.html ]; then
            echo "Report uploaded as artifact." >> $GITHUB_STEP_SUMMARY
          else
            echo "No report generated." >> $GITHUB_STEP_SUMMARY
          fi
