name: Smoke (Preview & Prod)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  smoke-preview:
    name: Preview smoke
    runs-on: ubuntu-latest
    env:
      API: ${{ secrets.PREVIEW_API_BASE }}          # e.g. https://preview-api.instainstru.com
      ORIGIN: ${{ secrets.PREVIEW_ORIGIN }}          # e.g. https://preview.instainstru.com
      GATED: ${{ secrets.GATED_ENDPOINT }}           # e.g. /v1/gated/ping
      WEBHOOK: ${{ secrets.WEBHOOK_ENDPOINT }}       # e.g. /webhooks/stripe/payment-events
      MODE: preview
    steps:
      - name: Health
        run: |
          set -e
          curl -fSs --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i "$API/health" | tee /tmp/health.txt
          grep -i "^x-site-mode: preview" /tmp/health.txt
          # Ensure no local testing header leaks into preview
          ! grep -qi '^x-testing: 1' /tmp/health.txt
      - name: CORS preflight (allowed)
        run: |
          curl -fSs --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i -X OPTIONS "$API$GATED" \
            -H "Origin: $ORIGIN" \
            -H "Access-Control-Request-Method: GET" \
            -H "Access-Control-Request-Headers: content-type"
      - name: Phase-gated route (200 in preview)
        run: |
          set -e
          URL="$API$GATED"
          curl -fSs --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i "$URL" \
            -H "Origin: $ORIGIN" \
            -H "x-staff-preview-token: ${{ secrets.PREVIEW_HEADER_TOKEN }}" \
            | tee /tmp/g.txt
          grep -E "^HTTP/.+ 200" /tmp/g.txt
      - name: Webhook must ignore preview header (only if provided)
        run: |
          set +e
          curl -sS --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i -X POST "$API$WEBHOOK" \
            -H "x-staff-preview-token: ${{ secrets.PREVIEW_HEADER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{}' | tee /tmp/w.txt
          grep -E "^HTTP/.* (400|401|403)" /tmp/w.txt
      - name: Metrics endpoint reachable
        run: |
          curl -fSs --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused "$API/metrics" | head -n 20

  smoke-preview-web:
    name: Preview Web gate (frontend)
    runs-on: ubuntu-latest
    env:
      PREVIEW_WEB: ${{ secrets.PREVIEW_WEB || secrets.PREVIEW_ORIGIN }}
    steps:
      - name: GET guaranteed gated path should redirect to /staff-login (no cookie)
        run: |
          set -e
          # prefer a path that is not in the allowlist and not public
          curl -fSs --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i --max-redirs 0 \
            -H "Cache-Control: no-cache" -H "Pragma: no-cache" \
            "$PREVIEW_WEB/instructor/console?ts=$(date +%s)" | tee /tmp/web.txt
          grep -E "^HTTP/.* (301|302|307|308)" /tmp/web.txt
          grep -i "location: /staff-login" /tmp/web.txt
      - name: robots header present
        run: |
          curl -fSs --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -I "$PREVIEW_WEB/" | grep -i "x-robots-tag: noindex"

  smoke-prod:
    name: Prod smoke (beta mode)
    runs-on: ubuntu-latest
    env:
      API: ${{ secrets.PROD_API_BASE }}             # e.g. https://api.instainstru.com
      ORIGIN: ${{ secrets.BETA_ORIGIN }}            # e.g. https://beta.instainstru.com
      GATED: ${{ secrets.GATED_ENDPOINT }}          # e.g. /v1/gated/ping
      WEBHOOK: ${{ secrets.WEBHOOK_ENDPOINT }}      # e.g. /webhooks/stripe/payment-events
      MODE: prod
    steps:
      - name: Health
        run: |
          set -e
          curl -fSs --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i "$API/health" | tee /tmp/health.txt
          grep -i "^x-site-mode: prod" /tmp/health.txt
          grep -Ei "^x-phase:\s*(beta|instructor_only)" /tmp/health.txt
          # Ensure no local testing header leaks into prod
          ! grep -qi '^x-testing: 1' /tmp/health.txt
      - name: CORS preflight (allowed)
        run: |
          curl -fSs --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i -X OPTIONS "$API$GATED" \
            -H "Origin: $ORIGIN" \
            -H "Access-Control-Request-Method: GET" \
            -H "Access-Control-Request-Headers: content-type"
      - name: CSRF sanity (cross-origin POST should be blocked)
        run: |
          set +e
          curl -sS --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i -X POST "$API$GATED" -H "Origin: $ORIGIN" -d '{}' | tee /tmp/c.txt
          grep -E "^HTTP/.* (401|403|405)" /tmp/c.txt
      - name: Phase-gated route (401/403 in prod)
        run: |
          set +e
          URL="$API$GATED"
          curl -sS --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i "$URL" | tee /tmp/g.txt
          grep -E " 401| 403" /tmp/g.txt
      - name: Preview canary (no gates)
        if: ${{ false }}
        run: |
          # Example snippet to enable in preview workflow (kept disabled here for prod smoke)
          :
      - name: Webhook ignores preview header (only if provided)
        run: |
          set +e
          curl -sS --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused -i -X POST "$API$WEBHOOK" \
            -H "x-staff-preview-token: ${{ secrets.PREVIEW_HEADER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{}' | tee /tmp/w.txt
          grep -E "^HTTP/.* (400|401|403)" /tmp/w.txt
      - name: Metrics endpoint reachable
        run: |
          curl -fSs --connect-timeout 5 --max-time 20 --retry 3 --retry-delay 1 --retry-connrefused "$API/metrics" | head -n 20
