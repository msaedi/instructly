# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

InstaInstru is a marketplace platform for instantly booking private instructors in NYC.
- **Backend**: FastAPI (Python) with PostgreSQL, SQLAlchemy, and Redis caching
- **Frontend**: Next.js 16 with TypeScript and Tailwind CSS v4
- **Architecture**: Clean architecture with separated services, repositories, and route handlers
- **Status**: Production-ready, all systems complete, pre-beta launch

## Essential Commands

### Backend Development
```bash
cd backend
source venv/bin/activate

uvicorn app.main:app --reload

# Tests
pytest                           # All tests
pytest -m unit                   # Unit tests only
pytest -m integration            # Integration tests only
pytest -k "test_name"            # Single test

# Database operations
python scripts/prep_db.py int    # Reset INT database
python scripts/prep_db.py stg    # Reset STG database

# Code quality
black .                          # Format Python code
isort .                          # Sort imports
```

### Frontend Development
```bash
cd frontend
npm run dev                      # Development server
npm run build                    # Production build
npm run test                     # Jest tests
npm run lint                     # Run ESLint
npm run typecheck:strict-all     # Strictest TypeScript check (MUST PASS)
```

### Redis & Celery
```bash
docker-compose up -d             # Start Redis
celery -A app.tasks.celery_app worker --loglevel=info
celery -A app.tasks.celery_app beat --loglevel=info
```

### Test Credentials
- **Email**: john.smith@example.com (or any seeded user)
- **Password**: Test1234

## üö® MANDATORY: Post-Change Verification

### After ANY Frontend Changes
```bash
cd frontend
npm run test              # Jest tests
npm run lint              # ESLint
npm run typecheck         # Basic TypeScript check
npm run typecheck:strict  # Strict TypeScript check
npm run typecheck:strict-all  # Strictest TypeScript check (MUST PASS)
```
**Fix all errors/warnings before committing.** Do NOT use `// @ts-ignore` or `eslint-disable`.

### After ANY Backend Changes
```bash
cd backend
./venv/bin/pre-commit run --all-files
```
**Fix all errors before committing.** Do NOT use `--no-verify` or unjustified `# type: ignore`.

## üî¥ CRITICAL: ULID Architecture ‚Äî ALL IDs are Strings!

All IDs are ULIDs (26-character strings like `01K2GY3VEVJWKZDVH5HMNXEVRD`), NOT integers.

**Python:**
```python
import ulid
class User(Base):
    id: Mapped[str] = mapped_column(String(26), primary_key=True, default=lambda: str(ulid.ULID()))
```

**TypeScript:**
```typescript
interface User {
  id: string;              // NOT number! Always ULID string
  instructor_id: string;   // NOT number!
}
```

**Rules:**
- Never use `parseInt()` on IDs ‚Äî they're ULID strings
- Never compare IDs numerically ‚Äî use string comparison
- Never use `number` type for IDs in TypeScript ‚Äî always `string`
- Always 26 characters, generated by application (not database)

## Architecture

### Backend (FastAPI) ‚Äî 5 Layers
1. **Routes**: HTTP endpoints ‚Üí `backend/app/routes/`
2. **Services**: Business logic with DI ‚Üí `backend/app/services/`
3. **Repositories**: Data access abstraction ‚Üí `backend/app/repositories/`
4. **Models**: Database schemas ‚Üí `backend/app/models/`
5. **Schemas**: Pydantic validation ‚Üí `backend/app/schemas/`

**Backend patterns (enforced):**
- All services extend `BaseService`
- Use `@measure_operation` decorator on public methods
- Repository pattern: `service.repository.method()` ‚Äî never direct DB queries in services
- Transaction pattern: `with self.transaction():` ‚Äî never `db.commit()`
- Dependency injection everywhere ‚Äî no singletons

### Frontend (Next.js 16) ‚Äî Flat Structure (NO `src/` directory)
- `app/` ‚Äî Page routing and layouts (App Router)
- `components/` ‚Äî Reusable UI components
- `features/` ‚Äî Feature-specific code (includes API services, hooks)
- `hooks/` ‚Äî Custom React hooks
- `lib/` ‚Äî API client and utilities
- `e2e/` ‚Äî Playwright E2E tests

### Key Architectural Decisions
- **Time-Based Booking**: Time ranges, not slot entities (instructor_id, date, start_time, end_time)
- **Bitmap Availability**: 1440-bit per day (70% storage reduction vs slots)
- **24hr Pre-Authorization**: Authorized T-24hr, captured T+24hr (chargeback protection)
- **Per-User Conversation State**: Independent archive/trash for each participant
- **Repository Pattern**: 100% enforced via pre-commit hooks
- **RBAC**: 30 permissions, not role-based checks
- **Dual Environments**: Preview and Beta for phased rollout

### Technical Debt (Isolated)
Frontend availability code has a mental model mismatch ‚Äî believes slots are database entities with IDs. Legacy files isolated in `frontend/legacy-patterns/`:
- `useAvailabilityOperations.ts` (600 lines ‚Üí target ~50)
- `operationGenerator.ts` (to be deleted)
- `slotHelpers.ts` (to be simplified)

## üõ°Ô∏è Engineering Guardrails

### TypeScript (Strictest Possible ‚Äî Zero Errors)
```json
{
  "strict": true,
  "noUncheckedIndexedAccess": true,
  "exactOptionalPropertyTypes": true,
  "noImplicitReturns": true,
  "noImplicitOverride": true,
  "noFallthroughCasesInSwitch": true,
  "noUnusedLocals": true,
  "noUnusedParameters": true,
  "noPropertyAccessFromIndexSignature": true
}
```

### Backend Type Safety (mypy strict)
- Repositories: 100% strict typing
- Services/Routes: ~95% strict (conscious exceptions for external SDKs)

### Dual-Mode Request Validation
```python
# Production (default): extra='ignore'
class UserRequest(BaseModel):
    model_config = ConfigDict(extra='ignore')

# Strict mode (STRICT_SCHEMAS=1): extra='forbid' ‚Üí 422 on unknown fields
class UserRequest(StrictRequestModel):
    model_config = ConfigDict(extra='forbid')
```

### CI/CD Quality Gates
Every PR must pass: TypeScript (0 errors), API contract (no drift), mypy strict, bundle size limits, security audit (pip-audit/npm audit), all tests passing, pre-commit hooks.

### Pre-Commit Hooks
```bash
pre-commit install   # Run from repo root
```
1. **Repository Pattern** (`check-repository-pattern`): Blocks `self.db.query()`, `self.db.add()`, `self.db.commit()` in services. Use `# repo-pattern-ignore: <reason>` for exceptions.
2. **Timezone** (`check-timezone-usage`): Blocks `date.today()`. Use `get_user_today_by_id(user_id, self.db)` from `app.core.timezone_utils`.
3. **API Contracts** (`api-contracts`): Ensures all endpoints return Pydantic response models.

Emergency bypass only: `git commit --no-verify -m "Emergency fix: reason"`

### Repository Metrics History (DO NOT REVERT)
`metrics_history.json` is intentionally versioned. Always keep and commit changes.

## üìã API Versioning & Contracts

**ALL API routes are under `/api/v1/*`** ‚Äî no exceptions (auth, admin, health, metrics ‚Äî everything except `/docs`, `/redoc`, `/openapi.json`).

### OpenAPI ‚Üí TypeScript Contract Enforcement
1. Backend exports deterministic OpenAPI spec
2. Frontend generates types via `openapi-typescript`
3. Types accessed via shim at `frontend/features/shared/api/types.ts`
4. CI blocks on any drift

**NEVER import generated types directly ‚Äî always use the shim.**

### API Migration Checklist

When migrating endpoints, you MUST update ALL consumers. The codebase has multiple API client patterns:
- Generated Orval hooks in `features/` directories
- Service layers in `features/shared/api/`
- Direct fetch calls in components
- E2E test mocks in `e2e/`

**Steps:**
1. Find ALL consumers: `grep -r "/api/old-path" frontend/ --include="*.ts" --include="*.tsx" | grep -v node_modules`
2. Update all consumers, service layers, and E2E mocks
3. Run the **mandatory** global audit:
```bash
# Must return EMPTY (or only intentionally non-v1 endpoints)
grep -rn '"/api/' frontend/ --include="*.ts" --include="*.tsx" | \
  grep -v '/api/v1' | grep -v node_modules | grep -v '.d.ts' | grep -v '.next/' | \
  grep -v '/api/auth' | grep -v '/api/admin' | grep -v '/api/config' | \
  grep -v '/api/public' | grep -v '/api/payments' | grep -v '/api/uploads' | \
  grep -v '/api/users' | grep -v 'import.*from'
```
4. Browser-verify: load affected pages and check Network tab for 404s

A migration is NOT complete until the grep audit returns zero results.

## üõ°Ô∏è Database Safety

### Three-Tier Architecture

| Tier | Env Var | Database | Usage |
|------|---------|----------|-------|
| **INT** üü¢ | *(default ‚Äî no flag needed)* | `instainstru_test` | pytest, scripts |
| **STG** üü° | `USE_STG_DATABASE=true` | `instainstru_stg` | Local dev (`./run_backend.py` uses this) |
| **PROD** üî¥ | `USE_PROD_DATABASE=true` | Supabase PostgreSQL | Requires interactive confirmation |

`settings.database_url` defaults to INT ‚Äî safe by default.

### Database Commands
```bash
cd backend
python scripts/prep_db.py int    # Reset INT (default)
python scripts/prep_db.py stg    # Reset STG
python scripts/prep_db.py prod   # Production (requires confirmation)
```

Other env vars: `INSTAINSTRU_PRODUCTION_MODE=true` (production servers), `CI=true` (CI uses own DATABASE_URL).

### Migration Approach (Development Phase)
**Modify existing migration files** in `backend/alembic/versions/` ‚Äî do NOT create new ones with `alembic revision`. Reset and rebuild with `prep_db.py` since no production data exists.

## üîß CI Database Image

Custom PostgreSQL: `ghcr.io/msaedi/instructly-ci-postgres:14-postgis-pgvector`
- Source: `.github/docker/postgres-ci/Dockerfile`
- Required: both PostGIS AND pgvector ‚Äî migrations fail without them
- Do NOT use standard postgres image or random community images

## Client-Side Caching: React Query (Mandatory)

ALL data fetching uses React Query (TanStack Query v5) ‚Äî never raw `fetch()` or `useEffect` for API calls.

```tsx
import { useQuery } from '@tanstack/react-query';
import { queryKeys } from '@/lib/react-query/queryClient';
import { queryFn } from '@/lib/react-query/api';

const { data, isLoading } = useQuery({
  queryKey: queryKeys.instructors.search({ service: 'yoga' }),
  queryFn: () => queryFn('/api/v1/instructors/search?service=yoga'),
  staleTime: 1000 * 60 * 5,
});
```

**Cache TTLs:** User data: `Infinity` | Categories: `1hr` | Profiles: `15min` | Search/Availability: `5min` | Real-time: `1min`

## Frontend Logging

Use the logger, not `console.log`:
```typescript
import { logger } from '@/lib/logger';
logger.debug('msg', { context: data });
logger.error('msg', error);
```

## üåê Dual Environment Architecture

| Environment | Domain | Purpose |
|-------------|--------|---------|
| **Preview** | preview.instainstru.com | Internal testing, stakeholder demos |
| **Beta** | beta.instainstru.com | Beta users, public launch |

Detection: `NEXT_PUBLIC_SITE_MODE` (frontend), `SITE_MODE` (backend), `X-Site-Mode`/`X-Phase` headers. Different Stripe accounts, email templates, and feature flags per environment.

## Schema-Owned Construction Pattern

Schemas own privacy transformation logic:
```python
class InstructorInfo:
    @classmethod
    def from_user(cls, user):
        return cls(first_name=user.first_name, last_initial=user.last_name[0] if user.last_name else "")
```

## Automatic Timezone Detection

ZIP code ‚Üí timezone mapping during registration:
- NYC zips (100-119) ‚Üí `America/New_York`
- LA zips (900-969) ‚Üí `America/Los_Angeles`
- Chicago zips (606-608) ‚Üí `America/Chicago`
- Invalid/missing ‚Üí defaults to `America/New_York`

## Long-Running Command Output Capture

For ANY command >30 seconds, capture output to a file:
```bash
pytest 2>&1 | tee /tmp/test.log
locust -f locustfile.py --headless -u 150 -r 10 -t 3m 2>&1 | tee /tmp/loadtest.log
```

## Adding New Features

1. Database model in `backend/app/models/`
2. Pydantic schemas in `backend/app/schemas/`
3. Repository methods in `backend/app/repositories/`
4. Service logic in `backend/app/services/`
5. API routes in `backend/app/routes/`
6. Tests in `backend/tests/`
7. Update frontend types and API client
8. Implement UI components

## Configuration

- Backend: `.env.example` ‚Üí `.env`
- Frontend: `.env.local.example` ‚Üí `.env.local`
- Never commit `.env` files

## Infrastructure (Render)

API, Redis ($7/mo), Celery Worker, Celery Beat, Flower, Supabase PostgreSQL ‚Äî ~$60/month total. Assets via Cloudflare R2 (`assets.instainstru.com`).

## Documentation

Key docs in `docs/`:
- Project Overview: `docs/project-overview/01_core_project_info.md`
- Architecture: `docs/architecture/02_architecture_state.md`
- Work Streams: `docs/project-status/03_work-streams-status.md`
- System Capabilities: `docs/project-status/04_system-capabilities.md`

A-Team designs in `docs/a-team-deliverables/` ‚Äî ASCII mockups are the official designs.

## Team Structure

- **X-Team**: Technical implementation (you are part of this)
- **A-Team**: UX/Design decisions (separate team)

## üìÅ Guardrail Files Reference

- **TypeScript Config**: `frontend/tsconfig.json`
- **API Contract Shim**: `frontend/features/shared/api/types.ts`
- **Strict DTO Base**: `backend/app/schemas/_strict_base.py`
- **OpenAPI Export**: `backend/scripts/export_openapi.py`, `backend/app/openapi_app.py`
- **Public Env Guard**: `frontend/lib/publicEnv.ts`, `frontend/scripts/verify-public-env.mjs`
- **Rate Limiter**: `backend/app/middleware/rate_limiter.py`
- **Pre-commit Hooks**: `.pre-commit-config.yaml`
- **CI Workflow**: `.github/workflows/ci.yml`
- **Env Contract**: `.github/workflows/env-contract.yml`
- **Schemathesis**: `.github/workflows/schemathesis.yml`
