'use client';

import { useEffect, useMemo, useState } from 'react';
import { fetchWithAuth, API_ENDPOINTS, getErrorMessage } from '@/lib/api';
import { logger } from '@/lib/logger';
import UserProfileDropdown from '@/components/UserProfileDropdown';

type Profile = {
  first_name: string;
  last_name: string;
  postal_code: string;
  bio: string;
  years_experience: number;
  min_advance_booking_hours?: number;
  buffer_time_minutes?: number;
};

type ServiceAreaItem = { id: string; neighborhood_id?: string; ntacode?: string | null; name?: string | null; borough?: string | null };
type ServiceAreasResponse = { items: ServiceAreaItem[]; total: number };
type NYCZipCheck = { is_nyc: boolean; borough?: string | null };

export default function InstructorProfileSettingsPage() {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [profile, setProfile] = useState<Profile>({
    first_name: '',
    last_name: '',
    postal_code: '',
    bio: '',
    years_experience: 0
  });
  const [isNYC, setIsNYC] = useState<boolean>(true); // default to true for now
  const [selectedNeighborhoods, setSelectedNeighborhoods] = useState<Set<string>>(new Set());
  const [boroughOpen, setBoroughOpen] = useState<string | null>(null);
  const [boroughNeighborhoods, setBoroughNeighborhoods] = useState<Record<string, ServiceAreaItem[]>>({});
  const [boroughFilter, setBoroughFilter] = useState<string>('');
  const [idToItem, setIdToItem] = useState<Record<string, ServiceAreaItem>>({});

  useEffect(() => {
    const load = async () => {
      try {
        setLoading(true);
        const res = await fetchWithAuth(API_ENDPOINTS.INSTRUCTOR_PROFILE);
        if (!res.ok) {
          setError(await getErrorMessage(res));
          return;
        }
        const data = await res.json();

        // Get user info for name fields
        const userRes = await fetchWithAuth('/api/users/me');
        let firstName = '';
        let lastName = '';
        if (userRes.ok) {
          const userData = await userRes.json();
          firstName = userData.first_name || '';
          lastName = userData.last_name || '';
        }

        // Get postal code from default address
        let postalCode = '';
        try {
          const addrRes = await fetchWithAuth('/api/addresses/me');
          if (addrRes.ok) {
            const list = await addrRes.json();
            const def = (list.items || []).find((a: any) => a.is_default) || (list.items || [])[0];
            postalCode = def?.postal_code || '';
          }
        } catch {}

        setProfile({
          first_name: firstName,
          last_name: lastName,
          postal_code: postalCode,
          bio: data.bio || '',
          years_experience: data.years_experience ?? 0,
          min_advance_booking_hours: data.min_advance_booking_hours ?? 2,
          buffer_time_minutes: data.buffer_time_minutes ?? 0,
        });

        // Prefill service areas (neighborhoods)
        try {
          const areasRes = await fetchWithAuth('/api/addresses/service-areas/me');
          if (areasRes.ok) {
            const areas: ServiceAreasResponse = await areasRes.json();
            const items = (areas.items || []) as ServiceAreaItem[];
            const ids = items
              .map((a) => a.neighborhood_id || (a as any).id)
              .filter((v: string | undefined): v is string => typeof v === 'string');
            setSelectedNeighborhoods(new Set(ids));
            // Prime name map so selections show even before a borough loads
            setIdToItem((prev) => {
              const next = { ...prev } as Record<string, ServiceAreaItem>;
              for (const a of items) {
                const nid = a.neighborhood_id || (a as any).id;
                if (nid) next[nid] = a;
              }
              return next;
            });
          }
        } catch {}

        // Detect NYC from default address postal code if available
        try {
          const addrRes = await fetchWithAuth('/api/addresses/me');
          if (addrRes.ok) {
            const list = await addrRes.json();
            const def = (list.items || []).find((a: any) => a.is_default) || (list.items || [])[0];
            const zip = def?.postal_code;
            if (zip) {
              const nycRes = await fetch(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}${API_ENDPOINTS.NYC_ZIP_CHECK}?zip=${encodeURIComponent(zip)}`);
              if (nycRes.ok) {
                const nyc: NYCZipCheck = await nycRes.json();
                setIsNYC(!!nyc.is_nyc);
              }
            }
          }
        } catch {}
      } catch (e) {
        logger.error('Failed to load profile', e);
        setError('Failed to load profile');
      } finally {
        setLoading(false);
      }
    };
    void load();
  }, []);

  const canSave = useMemo(() => {
    return profile.bio.trim().length >= 1;
  }, [profile]);

  const save = async () => {
    try {
      setSaving(true);
      setError(null);
      setSuccess(null);
      // Update user info if changed
      if (profile.first_name || profile.last_name) {
        await fetchWithAuth('/api/users/me', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            first_name: profile.first_name.trim(),
            last_name: profile.last_name.trim(),
          }),
        });
      }

      const payload = {
        bio: profile.bio.trim(),
        years_experience: Number(profile.years_experience) || 0,
        min_advance_booking_hours: profile.min_advance_booking_hours ?? 2,
        buffer_time_minutes: profile.buffer_time_minutes ?? 0,
      };
      const res = await fetchWithAuth(API_ENDPOINTS.INSTRUCTOR_PROFILE, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        setError(await getErrorMessage(res));
        return;
      }

      // Persist service areas
      try {
        await fetchWithAuth('/api/addresses/service-areas/me', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ neighborhood_ids: Array.from(selectedNeighborhoods) }),
        });
      } catch {}

      setSuccess('Profile saved');
    } catch (e) {
      setError('Failed to save profile');
    } finally {
      setSaving(false);
    }
  };

  // NYC helpers
  const NYC_BOROUGHS = ['Manhattan', 'Brooklyn', 'Queens', 'Bronx', 'Staten Island'] as const;

  const loadBoroughNeighborhoods = async (borough: string) => {
    if (boroughNeighborhoods[borough]) return;
    try {
      const url = `${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/api/addresses/regions/neighborhoods?region_type=nyc&borough=${encodeURIComponent(borough)}&per_page=500`;
      const r = await fetch(url);
      if (r.ok) {
        const data = await r.json();
        const list = (data.items || []) as ServiceAreaItem[];
        setBoroughNeighborhoods((prev) => ({ ...prev, [borough]: list }));
        // Update id->item map for display in the selection panel
        setIdToItem((prev) => {
          const next = { ...prev } as Record<string, ServiceAreaItem>;
          for (const it of list) {
            const nid = it.neighborhood_id || (it as any).id;
            if (nid) next[nid] = it;
          }
          return next;
        });
      }
    } catch {}
  };

  const toggleBoroughAll = (borough: string, value: boolean) => {
    const items = boroughNeighborhoods[borough] || [];
    const ids = items.map((i) => i.neighborhood_id || (i as any).id);
    setSelectedNeighborhoods((prev) => {
      const next = new Set(prev);
      if (value) {
        ids.forEach((id) => next.add(id));
      } else {
        ids.forEach((id) => next.delete(id));
      }
      return next;
    });
  };

  const toggleNeighborhood = (id: string) => {
    setSelectedNeighborhoods((prev) => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id);
      else next.add(id);
      return next;
    });
  };

  // Compute borough selection status for indeterminate styling
  const getBoroughCounts = (borough: string) => {
    const list = boroughNeighborhoods[borough] || [];
    const ids = list.map((n) => n.neighborhood_id || (n as any).id).filter(Boolean) as string[];
    let selected = 0;
    if (ids.length) {
      for (const id of ids) if (selectedNeighborhoods.has(id)) selected++;
    } else {
      // Fallback: count by idToItem when list not loaded
      for (const id of selectedNeighborhoods) if (idToItem[id]?.borough === borough) selected++;
    }
    return { selected, total: ids.length };
  };

  if (loading) return <div className="p-8">Loading...</div>;

  return (
    <div className="min-h-screen">
      {/* Header - matching onboarding pages */}
      <header className="bg-white/90 backdrop-blur-sm border-b border-gray-200 px-6 py-4">
        <div className="flex items-center justify-between max-w-full relative">
          <a href="/" className="inline-block">
            <h1 className="text-3xl font-bold text-purple-700 hover:text-purple-800 transition-colors cursor-pointer pl-4">iNSTAiNSTRU</h1>
          </a>

          {/* Progress Bar - 4 Steps - Absolutely centered */}
          <div className="absolute left-1/2 transform -translate-x-1/2 flex items-center gap-0">
            {/* Walking Stick Figure Animation - positioned to show on step 1 */}
            <div className="absolute animate-walk" style={{ top: '-12px', left: '-28px' }}>
              <svg width="16" height="20" viewBox="0 0 16 20" fill="none">
                {/* Head */}
                <circle cx="8" cy="4" r="2.5" stroke="#6A0DAD" strokeWidth="1.2" fill="none" />
                {/* Body */}
                <line x1="8" y1="6.5" x2="8" y2="12" stroke="#6A0DAD" strokeWidth="1.2" />
                {/* Left arm */}
                <line x1="8" y1="8" x2="5" y2="10" stroke="#6A0DAD" strokeWidth="1.2" className="animate-leftArm" />
                {/* Right arm */}
                <line x1="8" y1="8" x2="11" y2="10" stroke="#6A0DAD" strokeWidth="1.2" className="animate-rightArm" />
                {/* Left leg */}
                <line x1="8" y1="12" x2="6" y2="17" stroke="#6A0DAD" strokeWidth="1.2" className="animate-leftLeg" />
                {/* Right leg */}
                <line x1="8" y1="12" x2="10" y2="17" stroke="#6A0DAD" strokeWidth="1.2" className="animate-rightLeg" />
              </svg>
            </div>

            {/* Step 1 - Current (Profile) */}
            <div className="flex items-center">
              <div className="flex flex-col items-center relative">
                <button
                  onClick={() => {/* Already on this page */}}
                  className="w-6 h-6 rounded-full border-2 border-purple-300 bg-purple-100 hover:border-purple-400 transition-colors cursor-pointer"
                  title="Step 1: Account Setup (Current)"
                ></button>
                <span className="text-[10px] text-gray-600 mt-1 whitespace-nowrap absolute top-7">Account Setup</span>
              </div>
              <div className="w-60 h-0.5 bg-gray-300"></div>
            </div>

            {/* Step 2 - Upcoming */}
            <div className="flex items-center">
              <div className="flex flex-col items-center relative">
                <button
                  onClick={() => window.location.href = '/instructor/onboarding/skill-selection'}
                  className="w-6 h-6 rounded-full border-2 border-gray-300 hover:border-gray-400 transition-colors cursor-pointer"
                  title="Step 2: Skills & Pricing"
                ></button>
                <span className="text-[10px] text-gray-600 mt-1 whitespace-nowrap absolute top-7">Add Skills</span>
              </div>
              <div className="w-60 h-0.5 bg-gray-300"></div>
            </div>

            {/* Step 3 - Upcoming */}
            <div className="flex items-center">
              <div className="flex flex-col items-center relative">
                <button
                  onClick={() => window.location.href = '/instructor/onboarding/verification'}
                  className="w-6 h-6 rounded-full border-2 border-gray-300 hover:border-gray-400 transition-colors cursor-pointer"
                  title="Step 3: Verification"
                ></button>
                <span className="text-[10px] text-gray-600 mt-1 whitespace-nowrap absolute top-7">Verify Identity</span>
              </div>
              <div className="w-60 h-0.5 bg-gray-300"></div>
            </div>

            {/* Step 4 - Upcoming */}
            <div className="flex items-center">
              <div className="flex flex-col items-center relative">
                <button
                  onClick={() => window.location.href = '/instructor/onboarding/payment-setup'}
                  className="w-6 h-6 rounded-full border-2 border-gray-300 hover:border-gray-400 transition-colors cursor-pointer"
                  title="Step 4: Payment Setup"
                ></button>
                <span className="text-[10px] text-gray-600 mt-1 whitespace-nowrap absolute top-7">Payment Setup</span>
              </div>
            </div>
          </div>

          <div className="pr-4">
            <UserProfileDropdown />
          </div>
        </div>
      </header>

      <div className="container mx-auto px-8 lg:px-32 py-8 max-w-6xl">
        {/* Page Header with subtle purple accent - matching verification page */}
        <div className="bg-white rounded-lg p-6 mb-8 border border-gray-200">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
              <svg className="w-6 h-6 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </div>
            <div>
              <h1 className="text-3xl font-bold text-gray-800">Set up your profile</h1>
              <p className="text-gray-600">Complete your instructor profile to start teaching</p>
            </div>
          </div>
        </div>

        {error && (
          <div className="mb-6 rounded-lg bg-red-50 border border-red-200 text-red-700 px-4 py-3">
            {error}
          </div>
        )}
        {success && (
          <div className="mb-6 rounded-lg bg-green-50 border border-green-200 text-green-700 px-4 py-3">
            {success}
          </div>
        )}

        <div className="mt-8 bg-white rounded-lg p-6 border border-gray-200">
          <h2 className="text-lg font-medium text-gray-900 mb-4">Your Profile Information</h2>

          {/* Personal Information Card - styled like skill selection cards */}
          <div className="rounded-lg border border-gray-200 bg-gray-50 p-5 hover:shadow-sm transition-shadow mb-4">
            <div className="flex items-start justify-between mb-4">
              <div>
                <div className="text-lg font-medium text-gray-900">Personal Information</div>
                <div className="text-sm text-gray-600 mt-1">Your basic profile details</div>
              </div>
            </div>

            {/* Input Fields Grid */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div className="bg-white rounded-lg p-3 border border-gray-200">
                <label className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2 block">First Name</label>
                <input
                  type="text"
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"
                  placeholder="John"
                  value={profile.first_name}
                  onChange={(e) => setProfile((p) => ({ ...p, first_name: e.target.value }))}
                />
              </div>

              <div className="bg-white rounded-lg p-3 border border-gray-200">
                <label className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2 block">Last Name</label>
                <input
                  type="text"
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"
                  placeholder="Smith"
                  value={profile.last_name}
                  onChange={(e) => setProfile((p) => ({ ...p, last_name: e.target.value }))}
                />
              </div>

              <div className="bg-white rounded-lg p-3 border border-gray-200">
                <label className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2 block">ZIP Code</label>
                <input
                  type="text"
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"
                  placeholder="10001"
                  value={profile.postal_code}
                  onChange={(e) => setProfile((p) => ({ ...p, postal_code: e.target.value }))}
                />
              </div>
            </div>
          </div>

          {/* Professional Information Card - styled like skill selection cards */}
          <div className="rounded-lg border border-gray-200 bg-gray-50 p-5 hover:shadow-sm transition-shadow mb-4">
            <div className="flex items-start justify-between mb-4">
              <div>
                <div className="text-lg font-medium text-gray-900">Professional Details</div>
                <div className="text-sm text-gray-600 mt-1">Share your experience and teaching preferences</div>
              </div>
            </div>

            {/* Bio Section */}
            <div className="mb-4 bg-white rounded-lg p-3 border border-gray-200">
              <label className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2 block">Bio</label>
              <textarea
                rows={4}
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"
                placeholder="Tell students about your experience, teaching style, and approach..."
                value={profile.bio}
                onChange={(e) => setProfile((p) => ({ ...p, bio: e.target.value }))}
              />
              <p className="text-xs text-gray-500 mt-1">This will be displayed on your public profile</p>
            </div>

            {/* Settings Grid - matching skill selection style */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div className="bg-white rounded-lg p-3 border border-gray-200">
                <label className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2 block">Years of Experience</label>
                <input
                  type="number"
                  min={0}
                  max={50}
                  value={profile.years_experience}
                  onChange={(e) => setProfile((p) => ({ ...p, years_experience: Number(e.target.value || 0) }))}
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-center font-medium focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"
                />
              </div>

              <div className="bg-white rounded-lg p-3 border border-gray-200">
                <label className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2 block">
                  Advance Notice (hours)
                </label>
                <input
                  type="number"
                  min={0}
                  max={168}
                  value={profile.min_advance_booking_hours ?? 2}
                  onChange={(e) => setProfile((p) => ({ ...p, min_advance_booking_hours: Number(e.target.value || 0) }))}
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-center font-medium focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"
                />
              </div>

              <div className="bg-white rounded-lg p-3 border border-gray-200">
                <label className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2 block">
                  Buffer Time (minutes)
                </label>
                <input
                  type="number"
                  min={0}
                  max={60}
                  value={profile.buffer_time_minutes ?? 0}
                  onChange={(e) => setProfile((p) => ({ ...p, buffer_time_minutes: Number(e.target.value || 0) }))}
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-center font-medium focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"
                />
              </div>
            </div>
          </div>

          {/* Service Areas Card - styled like skill selection cards */}
          <div className="rounded-lg border border-gray-200 bg-gray-50 p-5 hover:shadow-sm transition-shadow">
            <div className="flex items-start justify-between mb-4">
              <div>
                <div className="text-lg font-medium text-gray-900">Service Areas</div>
                <div className="text-sm text-gray-600 mt-1">Select the neighborhoods where you teach</div>
              </div>
            </div>

            {isNYC ? (
              <div className="space-y-3">
                {/* Borough Selection Buttons - styled like skill category buttons */}
                <div className="bg-white rounded-lg p-3 border border-gray-200">
                  <label className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2 block">Select Boroughs</label>
                  <div className="flex flex-wrap gap-2">
                    {NYC_BOROUGHS.map((b) => {
                      const { selected, total } = getBoroughCounts(b);
                      const isAll = total > 0 && selected > 0 && selected === total;
                      const isSome = selected > 0 && (!total || selected < total);
                      const open = boroughOpen === b;

                      return (
                        <button
                          key={b}
                          onClick={async () => {
                            setBoroughOpen(boroughOpen === b ? null : b);
                            await loadBoroughNeighborhoods(b);
                          }}
                          type="button"
                          className={`px-3 py-2 text-sm rounded-full font-semibold transition focus:outline-none focus:ring-2 focus:ring-purple-500/20 whitespace-nowrap ${
                            isAll || isSome
                              ? 'bg-purple-100 text-purple-700 border border-purple-300'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          } ${open ? 'ring-2 ring-purple-500/20' : ''}`}
                        >
                          {b}
                          {selected > 0 && (
                            <span className="ml-2 inline-flex h-5 min-w-[1.25rem] items-center justify-center rounded-full px-1.5 text-xs bg-purple-200 text-purple-800">
                              {selected}
                            </span>
                          )}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* Selected neighborhoods display */}
                {selectedNeighborhoods.size > 0 && (
                  <div className="bg-white rounded-lg p-3 border border-gray-200">
                    <label className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2 block">Selected Neighborhoods ({selectedNeighborhoods.size})</label>
                    <div className="flex flex-wrap gap-2">
                      {Array.from(selectedNeighborhoods).map((id) => {
                        const it = idToItem[id];
                        const label = it?.name || id;
                        const hint = it?.borough ? ` • ${it.borough}` : '';
                        return (
                          <span key={id} className="inline-flex items-center gap-2 rounded-full bg-purple-50 border border-purple-200 px-3 py-1 text-sm text-purple-700">
                            {label}
                            <span className="text-purple-500 text-xs">{hint}</span>
                            <button
                              className="w-4 h-4 flex items-center justify-center rounded-full hover:bg-purple-200 text-purple-500"
                              onClick={() => toggleNeighborhood(id)}
                              aria-label={`Remove ${label}`}
                            >
                              ×
                            </button>
                          </span>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Borough neighborhood selection panel */}
                {boroughOpen && (
                  <div className="bg-white rounded-lg p-4 border border-gray-200">
                    <div className="flex items-center justify-between mb-3">
                      <div className="font-medium text-gray-900">{boroughOpen} Neighborhoods</div>
                      <div className="flex gap-2">
                        <button
                          className="text-sm px-3 py-1 rounded-md bg-purple-100 text-purple-700 hover:bg-purple-200"
                          onClick={() => toggleBoroughAll(boroughOpen!, true)}
                        >
                          Select all
                        </button>
                        <button
                          className="text-sm px-3 py-1 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
                          onClick={() => toggleBoroughAll(boroughOpen!, false)}
                        >
                          Clear all
                        </button>
                      </div>
                    </div>

                    <div className="mb-3">
                      <input
                        type="text"
                        value={boroughFilter}
                        onChange={(e) => setBoroughFilter(e.target.value)}
                        placeholder="Search neighborhoods..."
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20"
                      />
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-80 overflow-auto">
                      {(boroughNeighborhoods[boroughOpen] || [])
                        .filter((n) => (n.name || '').toLowerCase().includes(boroughFilter.toLowerCase()))
                        .map((n) => {
                          const nid = n.neighborhood_id || (n as any).id;
                          const checked = selectedNeighborhoods.has(nid);
                          return (
                            <button
                              key={nid}
                              onClick={() => toggleNeighborhood(nid)}
                              className={`px-3 py-2 text-sm rounded-md transition-colors ${
                                checked
                                  ? 'bg-purple-100 text-purple-700 border border-purple-300'
                                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                              }`}
                            >
                              {n.name || nid}
                            </button>
                          );
                        })}
                    </div>
                  </div>
                )}
            ) : (
              <div className="mt-4 rounded-lg border border-dashed border-gray-300 p-4 text-sm text-gray-600">
                Your city is not yet supported for granular neighborhoods. We'll add it soon.
              </div>
            )}
          </div>

        </div>

        {/* Save Buttons - matching skill selection page style */}
        <div className="mt-8 flex gap-3">
          <button
            onClick={save}
            disabled={!canSave || saving}
            className="px-6 py-2.5 rounded-lg text-white bg-[#6A0DAD] hover:bg-[#5c0a9a] disabled:opacity-50 shadow-sm transition-colors"
          >
            {saving ? 'Saving...' : 'Save & Continue'}
          </button>
        </div>
      </div>

      {/* CSS Animations for Walking Stick Figure */}
      <style jsx>{`
        @keyframes walk {
          0% {
            transform: translateX(0);
          }
          100% {
            transform: translateX(0);
          }
        }

        @keyframes leftLeg {
          0%, 100% { transform: rotate(0deg); transform-origin: 8px 12px; }
          25% { transform: rotate(-15deg); transform-origin: 8px 12px; }
          75% { transform: rotate(15deg); transform-origin: 8px 12px; }
        }

        @keyframes rightLeg {
          0%, 100% { transform: rotate(0deg); transform-origin: 8px 12px; }
          25% { transform: rotate(15deg); transform-origin: 8px 12px; }
          75% { transform: rotate(-15deg); transform-origin: 8px 12px; }
        }

        @keyframes leftArm {
          0%, 100% { transform: rotate(0deg); transform-origin: 8px 8px; }
          25% { transform: rotate(20deg); transform-origin: 8px 8px; }
          75% { transform: rotate(-20deg); transform-origin: 8px 8px; }
        }

        @keyframes rightArm {
          0%, 100% { transform: rotate(0deg); transform-origin: 8px 8px; }
          25% { transform: rotate(-20deg); transform-origin: 8px 8px; }
          75% { transform: rotate(20deg); transform-origin: 8px 8px; }
        }

        .animate-walk {
          animation: walk 4s linear infinite;
        }

        .animate-leftLeg {
          animation: leftLeg 0.5s linear infinite;
        }

        .animate-rightLeg {
          animation: rightLeg 0.5s linear infinite;
        }

        .animate-leftArm {
          animation: leftArm 0.5s linear infinite;
        }

        .animate-rightArm {
          animation: rightArm 0.5s linear infinite;
        }
      `}</style>
    </div>
  );
}
