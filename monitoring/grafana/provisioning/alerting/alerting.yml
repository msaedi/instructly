apiVersion: 1

# Alert rule groups
groups:
  - name: InstaInstru Production Alerts
    folder: InstaInstru Dashboards
    interval: 1m
    rules:
      # Response Time Alert
      - uid: response-time-alert
        title: High Response Time (P95 > 500ms)
        condition: B
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus-uid
            model:
              expr: histogram_quantile(0.95, sum(rate(instainstru_service_operation_duration_seconds_bucket[5m])) by (le))
              interval: ""
              refId: A
          - refId: B
            queryType: ""
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.5
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: classic_conditions
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: "Service P95 latency has exceeded 500ms for 5 minutes"
          runbook_url: "https://wiki.instainstru.com/runbooks/high-response-time"
          summary: "High response time detected"
        labels:
          severity: warning
          team: backend

      # Error Rate Alert - Simplified
      - uid: error-rate-alert
        title: High Error Rate (> 1%)
        condition: B
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus-uid
            model:
              expr: (sum(rate(instainstru_http_requests_total{status_code=~"4..|5.."}[5m])) / sum(rate(instainstru_http_requests_total[5m]))) * 100
              interval: ""
              refId: A
          - refId: B
            queryType: ""
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: classic_conditions
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: "HTTP error rate has exceeded 1% for 5 minutes"
          runbook_url: "https://wiki.instainstru.com/runbooks/high-error-rate"
          summary: "High error rate detected"
        labels:
          severity: critical
          team: backend

      # Service Degradation Alert
      - uid: service-degradation-alert
        title: Service Degradation (P99 > 1s)
        condition: B
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus-uid
            model:
              expr: max(histogram_quantile(0.99, sum by (service, le) (rate(instainstru_service_operation_duration_seconds_bucket[5m]))))
              interval: ""
              refId: A
          - refId: B
            queryType: ""
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: classic_conditions
        noDataState: NoData
        execErrState: Alerting
        for: 3m
        annotations:
          description: "Service P99 latency has exceeded 1 second for 3 minutes"
          runbook_url: "https://wiki.instainstru.com/runbooks/service-degradation"
          summary: "Service degradation detected"
        labels:
          severity: critical
          team: backend

      # High Load Alert
      - uid: high-load-alert
        title: High Request Load (> 1000 req/s)
        condition: B
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus-uid
            model:
              expr: sum(rate(instainstru_http_requests_total[1m]))
              interval: ""
              refId: A
          - refId: B
            queryType: ""
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1000
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: classic_conditions
        noDataState: NoData
        execErrState: OK
        for: 10m
        annotations:
          description: "Request rate has exceeded 1000 req/s for 10 minutes"
          runbook_url: "https://wiki.instainstru.com/runbooks/high-load"
          summary: "High load detected"
        labels:
          severity: warning
          team: infrastructure

      # Cache Performance Alert - Simplified
      - uid: cache-performance-alert
        title: Low Cache Hit Rate (< 60%)
        condition: B
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus-uid
            model:
              expr: (sum(rate(instainstru_service_operations_total{service="CacheService", operation="get", status="success"}[5m])) / sum(rate(instainstru_service_operations_total{service="CacheService", operation="get"}[5m]))) * 100
              interval: ""
              refId: A
          - refId: B
            queryType: ""
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 60
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: classic_conditions
        noDataState: NoData
        execErrState: OK
        for: 10m
        annotations:
          description: "Cache hit rate has fallen below 60% for 10 minutes"
          runbook_url: "https://wiki.instainstru.com/runbooks/low-cache-hit-rate"
          summary: "Low cache performance detected"
        labels:
          severity: warning
          team: backend
